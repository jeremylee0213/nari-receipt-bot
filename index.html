<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lily's Receipt Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --primary: #9B72CF;
            --primary-dark: #7B52AF;
            --primary-light: #F3EEFA;
            --primary-glow: rgba(155,114,207,.25);
            --bg: linear-gradient(135deg, #F8F5FD 0%, #F0E8FA 50%, #EDE4F7 100%);
            --card: rgba(255,255,255,.72);
            --card-solid: #FDFCFF;
            --text: #3D2E5C;
            --muted: #9A8BB5;
            --border: rgba(155,114,207,.18);
            --success: #7EC8A0;
            --success-dark: #5BA87E;
            --warning: #E8B86D;
            --danger: #D97B8F;
            --radius: 14px;
            --lily-pink: #E8B4D0;
            --lily-white: #F5EEF8;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Noto Sans KR','Quicksand',sans-serif;
            background:var(--bg); color:var(--text); min-height:100vh;
            overflow-x:hidden; position:relative;
        }

        /* ===== Falling Lily Petals ===== */
        .petal-container { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; overflow:hidden; }
        .petal {
            position:absolute; top:-40px; opacity:0;
            animation:petal-fall linear forwards;
        }
        .petal svg { filter:drop-shadow(0 2px 4px rgba(155,114,207,.15)); }
        @keyframes petal-fall {
            0% { opacity:0; transform:translateX(0) rotate(0deg); }
            10% { opacity:.6; }
            90% { opacity:.4; }
            100% { opacity:0; transform:translateX(var(--drift)) rotate(var(--spin)); top:105vh; }
        }

        /* ===== Layout ===== */
        .app { display:flex; min-height:100vh; max-width:1500px; margin:0 auto; position:relative; z-index:1; }

        /* Left panel - Glassmorphism */
        .left {
            width:430px; min-width:430px;
            background:var(--card);
            backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
            border-right:1px solid var(--border);
            border-radius:0 24px 24px 0;
            display:flex; flex-direction:column; overflow-y:auto;
            box-shadow:4px 0 30px rgba(155,114,207,.08);
        }
        .right { flex:1; padding:24px; overflow-y:auto; }

        /* Header */
        .left-header {
            padding:24px 28px 18px;
            border-bottom:1px solid var(--border);
            background:linear-gradient(135deg, rgba(155,114,207,.08), rgba(232,180,208,.08));
        }
        .left-header h1 {
            font-family:'Quicksand','Noto Sans KR',sans-serif;
            font-size:24px; font-weight:700; color:var(--primary);
            display:flex; align-items:center; gap:8px;
        }
        .left-header p { font-size:12px; color:var(--muted); margin-top:3px; letter-spacing:.3px; }

        /* Main actions */
        .main-actions { padding:22px 28px; flex:1; display:flex; flex-direction:column; gap:16px; }

        /* Drop zone */
        .drop-zone {
            border:2px dashed var(--border); border-radius:var(--radius);
            padding:32px 20px; text-align:center; cursor:pointer;
            transition:all .3s ease;
            background:linear-gradient(135deg, var(--lily-white), rgba(243,238,250,.5));
        }
        .drop-zone:hover, .drop-zone.drag-over {
            border-color:var(--primary); background:var(--primary-light);
            transform:scale(1.01);
            box-shadow:0 4px 20px var(--primary-glow);
        }
        .drop-zone-icon { font-size:42px; margin-bottom:6px; }
        .drop-zone-text { font-size:13px; color:var(--muted); }
        .drop-zone-text strong { color:var(--primary); }

        .thumbnails { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
        .thumb {
            position:relative; width:56px; height:56px;
            border-radius:10px; overflow:hidden;
            border:2px solid var(--border); transition:all .2s;
        }
        .thumb:hover { transform:scale(1.1); border-color:var(--primary); box-shadow:0 2px 10px var(--primary-glow); }
        .thumb img { width:100%; height:100%; object-fit:cover; }
        .thumb-remove {
            position:absolute; top:2px; right:2px; width:18px; height:18px;
            background:var(--danger); color:#fff; border:none; border-radius:50%;
            font-size:9px; cursor:pointer; display:flex; align-items:center; justify-content:center;
            transition:transform .2s;
        }
        .thumb-remove:hover { transform:scale(1.2); }
        .file-count { font-size:12px; color:var(--muted); margin-top:4px; }

        /* OCR Button */
        .btn-ocr {
            padding:18px 24px; border:none; border-radius:16px; font-size:17px; font-weight:700;
            font-family:'Quicksand','Noto Sans KR',sans-serif;
            cursor:pointer; width:100%; color:#fff;
            background:linear-gradient(135deg, #B388E8, #9B72CF, #8B5CC0);
            box-shadow:0 6px 25px rgba(155,114,207,.35);
            transition:all .3s; position:relative; overflow:hidden;
            letter-spacing:.5px;
        }
        .btn-ocr::before {
            content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
            background:linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
            transition:left .5s;
        }
        .btn-ocr:hover:not(:disabled)::before { left:100%; }
        .btn-ocr:hover:not(:disabled) { transform:translateY(-3px); box-shadow:0 8px 30px rgba(155,114,207,.45); }
        .btn-ocr:active:not(:disabled) { transform:translateY(0); }
        .btn-ocr:disabled { opacity:.35; cursor:not-allowed; transform:none; }

        /* Excel Button */
        .btn-excel {
            padding:18px 24px; border:none; border-radius:16px; font-size:17px; font-weight:700;
            font-family:'Quicksand','Noto Sans KR',sans-serif;
            cursor:pointer; width:100%; color:#fff;
            background:linear-gradient(135deg, #A8D8B8, #7EC8A0, #5BA87E);
            box-shadow:0 6px 25px rgba(126,200,160,.3);
            transition:all .3s; position:relative; overflow:hidden;
            letter-spacing:.5px;
        }
        .btn-excel::before {
            content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
            background:linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
            transition:left .5s;
        }
        .btn-excel:hover::before { left:100%; }
        .btn-excel:hover { transform:translateY(-3px); box-shadow:0 8px 30px rgba(126,200,160,.4); }
        .btn-excel:active { transform:translateY(0); }
        .btn-excel.downloading { animation:btn-celebrate .6s ease; }
        @keyframes btn-celebrate {
            0% { transform:scale(1); }
            30% { transform:scale(.95); }
            60% { transform:scale(1.05); }
            100% { transform:scale(1); }
        }

        /* Status bar */
        .status-bar { padding:10px 14px; border-radius:10px; font-size:13px; font-weight:500; display:none; align-items:center; gap:8px; }
        .status-bar.show { display:flex; }
        .status-info { background:var(--primary-light); color:var(--primary); }
        .status-success { background:rgba(126,200,160,.15); color:var(--success-dark); }
        .status-error { background:rgba(217,123,143,.12); color:var(--danger); }

        /* Loading animation - lily themed */
        .loading-container { display:none; flex-direction:column; align-items:center; gap:16px; padding:20px; }
        .loading-container.show { display:flex; }
        .loading-dots { display:flex; gap:10px; align-items:center; }
        .loading-dot {
            width:14px; height:14px; border-radius:50%;
            animation:lily-pulse 1.6s ease-in-out infinite;
        }
        .loading-dot:nth-child(1) { background:#C9A0E8; animation-delay:0s; }
        .loading-dot:nth-child(2) { background:#B388E8; animation-delay:.2s; }
        .loading-dot:nth-child(3) { background:#E8B4D0; animation-delay:.4s; }
        .loading-dot:nth-child(4) { background:#9B72CF; animation-delay:.6s; }
        @keyframes lily-pulse {
            0%,80%,100% { transform:scale(.4); opacity:.3; }
            40% { transform:scale(1.1); opacity:1; }
        }
        .loading-text { font-size:14px; font-weight:600; color:var(--primary); }
        .loading-sub { font-size:12px; color:var(--muted); }
        .progress-bar { width:100%; height:8px; background:rgba(155,114,207,.12); border-radius:4px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg,#B388E8,#E8B4D0,#9B72CF); border-radius:4px; transition:width .4s ease; }

        /* Lily particle burst */
        .particle-container { position:fixed; pointer-events:none; z-index:9999; }
        .particle {
            position:absolute; width:8px; height:8px; border-radius:50%;
            animation:particle-fly 1s ease-out forwards;
        }
        @keyframes particle-fly {
            0% { opacity:1; transform:translate(0,0) scale(1); }
            100% { opacity:0; transform:translate(var(--tx),var(--ty)) scale(0); }
        }

        /* Lily bloom celebration */
        .bloom-overlay {
            position:fixed; top:0; left:0; width:100%; height:100%;
            pointer-events:none; z-index:9998;
            display:flex; align-items:center; justify-content:center;
        }
        .bloom-lily {
            font-size:80px; opacity:0;
            animation:lily-bloom 2s ease-out forwards;
        }
        @keyframes lily-bloom {
            0% { opacity:0; transform:scale(0) rotate(-30deg); }
            30% { opacity:1; transform:scale(1.3) rotate(10deg); }
            50% { transform:scale(1) rotate(0deg); }
            70% { opacity:1; }
            100% { opacity:0; transform:scale(1.5) rotate(15deg) translateY(-40px); }
        }
        .bloom-text {
            position:absolute; font-size:20px; font-weight:700; color:var(--primary);
            opacity:0; animation:bloom-text-fade 2s ease-out .3s forwards;
            font-family:'Quicksand',sans-serif; text-shadow:0 2px 10px rgba(155,114,207,.3);
        }
        @keyframes bloom-text-fade {
            0% { opacity:0; transform:translateY(20px); }
            30% { opacity:1; transform:translateY(-50px); }
            70% { opacity:1; }
            100% { opacity:0; transform:translateY(-70px); }
        }

        /* Summary */
        .summary { display:flex; gap:10px; margin-top:8px; }
        .summary-item {
            flex:1; padding:14px; border-radius:12px; text-align:center;
            background:linear-gradient(135deg, var(--lily-white), var(--primary-light));
            border:1px solid var(--border);
        }
        .summary-value { font-size:22px; font-weight:900; color:var(--primary); font-family:'Quicksand',sans-serif; }
        .summary-label { font-size:11px; color:var(--muted); margin-top:2px; }

        /* Settings panel */
        .settings-toggle {
            padding:12px 28px; border-top:1px solid var(--border); cursor:pointer;
            display:flex; align-items:center; justify-content:space-between;
            font-size:12px; font-weight:600; color:var(--muted);
            background:rgba(243,238,250,.5); transition:background .2s;
        }
        .settings-toggle:hover { background:var(--primary-light); }
        .settings-panel {
            padding:0 28px; max-height:0; overflow:hidden;
            transition:max-height .3s ease, padding .3s ease;
            background:var(--card-solid);
        }
        .settings-panel.open { max-height:600px; padding:16px 28px; }
        .section { margin-bottom:12px; }
        .section-title { font-size:12px; font-weight:700; color:var(--primary); margin-bottom:8px; padding-bottom:4px; border-bottom:1px solid var(--primary-light); }

        label { display:block; font-size:11px; font-weight:500; color:var(--muted); margin-bottom:3px; }
        input, select {
            width:100%; padding:8px 12px; border:1px solid var(--border);
            border-radius:10px; font-size:13px; font-family:inherit; outline:none;
            transition:all .2s; background:rgba(255,255,255,.8);
        }
        input:focus, select:focus { border-color:var(--primary); box-shadow:0 0 0 3px var(--primary-glow); }
        .input-group { margin-bottom:8px; }
        .input-row { display:flex; gap:8px; }
        .input-row > div { flex:1; }

        /* API tabs */
        .api-selector { display:flex; border-radius:10px; overflow:hidden; border:1px solid var(--border); }
        .api-tab {
            flex:1; padding:6px 0; border:none; font-size:12px; font-weight:600;
            font-family:inherit; cursor:pointer; transition:all .2s; color:var(--muted);
            background:rgba(243,238,250,.4);
        }
        .api-tab+.api-tab { border-left:1px solid var(--border); }
        .api-tab.active { background:var(--primary); color:#fff; }
        .api-tab:hover:not(.active) { background:var(--primary-light); color:var(--primary); }
        .api-key-wrap { position:relative; }
        .api-key-toggle { position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; font-size:14px; color:var(--muted); }

        /* Name mapping */
        .mapping-list { max-height:150px; overflow-y:auto; margin-top:6px; }
        .mapping-item { display:flex; align-items:center; gap:4px; padding:4px 0; font-size:11px; border-bottom:1px solid var(--border); }
        .mapping-item span { flex:1; }
        .btn-sm { padding:4px 10px; font-size:11px; border:none; border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600; }
        .btn-outline-sm { background:transparent; color:var(--primary); border:1px solid var(--primary); transition:all .2s; }
        .btn-outline-sm:hover { background:var(--primary); color:#fff; }
        .row-btn { width:22px; height:22px; border:none; border-radius:6px; cursor:pointer; font-size:10px; display:flex; align-items:center; justify-content:center; transition:all .2s; }
        .row-btn-del { background:rgba(217,123,143,.12); color:var(--danger); }
        .row-btn-del:hover { background:var(--danger); color:#fff; }

        /* ===== Data Table ===== */
        .data-table-wrap { overflow-x:auto; border-radius:var(--radius); box-shadow:0 2px 15px rgba(155,114,207,.08); }
        .data-table { width:100%; border-collapse:collapse; font-size:13px; }
        .data-table th {
            background:linear-gradient(135deg, var(--primary), var(--primary-dark));
            color:#fff; padding:10px 12px; text-align:left; font-weight:600;
            white-space:nowrap; position:sticky; top:0; z-index:1;
        }
        .data-table th:first-child { border-radius:var(--radius) 0 0 0; }
        .data-table th:last-child { border-radius:0 var(--radius) 0 0; }
        .data-table td { padding:6px 10px; border-bottom:1px solid var(--border); white-space:nowrap; background:rgba(255,255,255,.6); }
        .data-table tr:hover td { background:var(--primary-light); }
        .data-table input {
            padding:4px 6px; font-size:12px; border:1px solid var(--border);
            border-radius:8px; width:100%; min-width:50px;
            background:rgba(255,255,255,.9);
        }
        .data-table .name-input { min-width:70px; }
        .data-table .service-input { min-width:120px; }
        .data-table .amount-input { min-width:70px; text-align:right; }
        .unknown-cell { background:rgba(232,180,109,.1) !important; }
        .unknown-cell input { border-color:var(--warning); background:rgba(232,180,109,.08); }

        .empty-state { text-align:center; padding:80px 20px; color:var(--muted); }
        .empty-state-icon { font-size:64px; margin-bottom:16px; }
        .empty-state p { font-size:14px; line-height:1.6; }

        .btn {
            display:inline-flex; align-items:center; justify-content:center; gap:6px;
            padding:7px 14px; border:none; border-radius:10px; font-size:12px;
            font-weight:600; font-family:inherit; cursor:pointer; transition:all .2s;
        }
        .btn-primary { background:var(--primary); color:#fff; }
        .btn-primary:hover { background:var(--primary-dark); transform:translateY(-1px); }
        .btn-outline { background:transparent; color:var(--primary); border:1px solid var(--primary); }
        .btn-outline:hover { background:var(--primary); color:#fff; }
    </style>
</head>
<body>
    <!-- Falling Lily Petals Background -->
    <div class="petal-container" id="petalContainer"></div>

    <div class="app">
        <!-- Left Panel -->
        <div class="left">
            <div class="left-header">
                <h1>&#127804; Lily's Receipt Bot</h1>
                <p>Japanese Taxi Invoice Auto Settlement</p>
            </div>

            <div class="main-actions">
                <!-- Upload -->
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">&#127804;</div>
                    <div class="drop-zone-text">
                        &#127804; <strong>Drag</strong>, <strong>Click</strong> or <strong>Ctrl+V</strong><br>
                        <small>PNG, JPG, PDF / Multiple files / Paste supported</small>
                    </div>
                    <input type="file" id="fileInput" accept="image/*,application/pdf" multiple hidden>
                </div>
                <div class="thumbnails" id="thumbnails"></div>
                <div class="file-count" id="fileCount"></div>

                <!-- Settings -->
                <div class="input-row">
                    <div class="input-group">
                        <label>&#127804; Month</label>
                        <select id="month">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Year</label>
                        <input type="number" id="year" value="2026" min="2019" max="2030">
                    </div>
                    <div class="input-group">
                        <label>Exchange Rate</label>
                        <input type="number" id="exchangeRate" step="0.0001" value="9.3416">
                    </div>
                    <div class="input-group">
                        <label>Remittance Fee</label>
                        <input type="number" id="remittanceFee" step="1" value="49485">
                    </div>
                </div>

                <!-- OCR Button -->
                <button class="btn-ocr" id="ocrBtn" onclick="startOCR()" disabled>
                    &#127804; Start OCR Analysis
                </button>

                <!-- Loading -->
                <div class="loading-container" id="loadingContainer">
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <div class="loading-text" id="loadingText">Analyzing receipts...</div>
                    <div class="loading-sub" id="loadingSub">AI is reading the Japanese text</div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                </div>

                <!-- Status -->
                <div class="status-bar" id="statusBar">
                    <span id="statusText"></span>
                </div>

                <!-- Download -->
                <div id="downloadSection" style="display:none">
                    <div class="summary" id="summary"></div>
                    <button class="btn-excel" id="excelBtn" onclick="downloadExcel()" style="margin-top:12px">
                        &#127804; Download Excel
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-toggle" onclick="toggleSettings()">
                <span>&#9881; API & Name Mapping Settings</span>
                <span id="settingsArrow">&#9660;</span>
            </div>
            <div class="settings-panel" id="settingsPanel">
                <div class="section">
                    <div class="section-title">AI API</div>
                    <div class="input-group">
                        <div class="api-selector">
                            <button class="api-tab active" data-api="claude" onclick="switchApi('claude')">Claude</button>
                            <button class="api-tab" data-api="gemini" onclick="switchApi('gemini')">Gemini</button>
                            <button class="api-tab" data-api="openai" onclick="switchApi('openai')">OpenAI</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="api-key-wrap">
                            <input type="password" id="apiKey" placeholder="API Key">
                            <button class="api-key-toggle" onclick="toggleApiKey()">&#128065;</button>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-title">Name Mapping</div>
                    <div class="input-row">
                        <div class="input-group"><input type="text" id="newNameRoman" placeholder="HONG GILDONG"></div>
                        <div class="input-group"><input type="text" id="newNameKorean" placeholder="&#54861;&#44600;&#46041;"></div>
                    </div>
                    <button class="btn-sm btn-outline-sm" onclick="addNameMapping()">Add</button>
                    <div class="mapping-list" id="mappingList"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right">
            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">&#127804;</div>
                <p>Upload receipt images and<br>start OCR analysis &#127804;</p>
            </div>

            <div id="dataView" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                    <h2 style="font-size:17px;font-weight:700;color:var(--primary);font-family:'Quicksand',sans-serif">&#127804; OCR Results</h2>
                    <div style="display:flex;gap:6px">
                        <button class="btn btn-outline" onclick="addRow()">+ Add Row</button>
                        <button class="btn btn-primary" onclick="sortData()">Sort by Date</button>
                    </div>
                </div>

                <div class="data-table-wrap">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Original Name</th>
                                <th>Korean Name</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Amount (JPY)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="dataBody"></tbody>
                    </table>
                </div>

                <div style="margin-top:14px;text-align:right">
                    <strong id="totalDisplay" style="font-size:15px;color:var(--primary);font-family:'Quicksand',sans-serif"></strong>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // ===== State =====
        let uploadedImages = [];
        let ocrResults = [];
        let currentApi = 'claude';

        const API_CONFIG = {
            claude: { label:'Claude', placeholder:'Claude API Key (sk-ant-...)', storageKey:'claude_api_key' },
            gemini: { label:'Gemini', placeholder:'Gemini API Key', storageKey:'gemini_api_key' },
            openai: { label:'OpenAI', placeholder:'OpenAI API Key (sk-...)', storageKey:'openai_api_key' },
        };

        const LOADING_MESSAGES = [
            { text:'&#127804; Analyzing receipts...', sub:'AI is reading Japanese text' },
            { text:'&#127804; Extracting data...', sub:'Finding dates, names, and amounts' },
            { text:'&#127804; Converting names...', sub:'Translating romaji to Korean' },
            { text:'&#127804; Almost done!', sub:'Final verification in progress' },
        ];

        // ===== Falling Lily Petals =====
        function createPetals() {
            const container = document.getElementById('petalContainer');
            const petalSVGs = [
                `<svg width="20" height="24" viewBox="0 0 20 24"><path d="M10 0C10 0 0 8 0 14c0 5.5 4.5 10 10 10s10-4.5 10-10C20 8 10 0 10 0z" fill="rgba(200,160,232,.35)"/></svg>`,
                `<svg width="16" height="20" viewBox="0 0 16 20"><path d="M8 0C8 0 0 6 0 11c0 5 3.5 9 8 9s8-4 8-9C16 6 8 0 8 0z" fill="rgba(232,180,208,.4)"/></svg>`,
                `<svg width="14" height="18" viewBox="0 0 14 18"><ellipse cx="7" cy="9" rx="7" ry="9" fill="rgba(179,136,232,.25)"/></svg>`,
            ];
            function spawnPetal() {
                const petal = document.createElement('div');
                petal.className = 'petal';
                petal.innerHTML = petalSVGs[Math.floor(Math.random() * petalSVGs.length)];
                petal.style.left = Math.random() * 100 + '%';
                petal.style.setProperty('--drift', (Math.random() * 100 - 50) + 'px');
                petal.style.setProperty('--spin', (Math.random() * 720 - 360) + 'deg');
                const duration = 8 + Math.random() * 7;
                petal.style.animationDuration = duration + 's';
                container.appendChild(petal);
                setTimeout(() => petal.remove(), duration * 1000);
            }
            setInterval(spawnPetal, 2500);
            for (let i = 0; i < 5; i++) setTimeout(spawnPetal, i * 800);
        }

        // ===== Lily Bloom Celebration =====
        function showLilyBloom(text) {
            const overlay = document.createElement('div');
            overlay.className = 'bloom-overlay';
            overlay.innerHTML = `
                <div class="bloom-lily">&#127804;</div>
                <div class="bloom-text">${text}</div>
            `;
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 2500);
        }

        // ===== Init =====
        window.addEventListener('DOMContentLoaded', () => {
            createPetals();

            const savedApi = localStorage.getItem('selected_api');
            if (savedApi && API_CONFIG[savedApi]) switchApi(savedApi);
            else switchApi('claude');

            document.getElementById('apiKey').addEventListener('change', e => {
                localStorage.setItem(API_CONFIG[currentApi].storageKey, e.target.value.trim());
            });

            const savedRate = localStorage.getItem('exchange_rate');
            const savedFee = localStorage.getItem('remittance_fee');
            if (savedRate) document.getElementById('exchangeRate').value = savedRate;
            if (savedFee) document.getElementById('remittanceFee').value = savedFee;

            document.getElementById('exchangeRate').addEventListener('change', e => localStorage.setItem('exchange_rate', e.target.value));
            document.getElementById('remittanceFee').addEventListener('change', e => localStorage.setItem('remittance_fee', e.target.value));

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
            fileInput.addEventListener('change', e => handleFiles(e.target.files));

            // Ctrl+V clipboard paste
            document.addEventListener('paste', e => {
                const items = e.clipboardData?.items;
                if (!items) return;
                const imageFiles = [];
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) imageFiles.push(file);
                    }
                }
                if (imageFiles.length > 0) {
                    e.preventDefault();
                    handlePastedImages(imageFiles);
                }
            });

            renderMappings();
        });

        // ===== Settings =====
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const arrow = document.getElementById('settingsArrow');
            panel.classList.toggle('open');
            arrow.innerHTML = panel.classList.contains('open') ? '&#9650;' : '&#9660;';
        }

        // ===== API =====
        function switchApi(api) {
            currentApi = api;
            const config = API_CONFIG[api];
            const input = document.getElementById('apiKey');
            document.querySelectorAll('.api-tab').forEach(t => t.classList.toggle('active', t.dataset.api === api));
            input.placeholder = config.placeholder;
            input.value = localStorage.getItem(config.storageKey) || '';
            input.type = 'password';
            localStorage.setItem('selected_api', api);
            updateOcrButton();
        }

        function toggleApiKey() {
            const i = document.getElementById('apiKey');
            i.type = i.type === 'password' ? 'text' : 'password';
        }

        // ===== File handling =====
        function handlePastedImages(files) {
            let added = 0;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = e => {
                    uploadedImages.push({ file, dataUrl: e.target.result });
                    added++;
                    renderThumbnails();
                    updateOcrButton();
                    if (added === 1) {
                        spawnParticles(document.getElementById('dropZone'));
                        showStatus(`&#127804; ${files.length} image(s) pasted from clipboard!`, 'success');
                        const dz = document.getElementById('dropZone');
                        dz.classList.add('drag-over');
                        setTimeout(() => dz.classList.remove('drag-over'), 600);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleFiles(files) {
            let added = 0;
            for (const file of files) {
                if (file.type === 'application/pdf') {
                    try {
                        showStatus('&#127804; Converting PDF to images...', 'info');
                        const pdfImages = await pdfToImages(file);
                        for (const img of pdfImages) {
                            uploadedImages.push(img);
                            added++;
                        }
                        renderThumbnails();
                        updateOcrButton();
                        showStatus(`&#127804; ${pdfImages.length} pages converted from PDF!`, 'success');
                        if (added > 0) spawnParticles(document.getElementById('dropZone'));
                    } catch (err) {
                        showStatus(`PDF error: ${err.message}`, 'error');
                    }
                } else if (file.type.match(/image\/(png|jpeg|jpg|webp)/)) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        uploadedImages.push({ file, dataUrl: e.target.result });
                        added++;
                        renderThumbnails();
                        updateOcrButton();
                        if (added === 1) spawnParticles(document.getElementById('dropZone'));
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        async function pdfToImages(file) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const images = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const scale = 2.0;
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');
                await page.render({ canvasContext: ctx, viewport }).promise;
                const dataUrl = canvas.toDataURL('image/png');
                images.push({
                    file: new File([await (await fetch(dataUrl)).blob()], `${file.name}_page${i}.png`, { type: 'image/png' }),
                    dataUrl
                });
            }
            return images;
        }

        function renderThumbnails() {
            const c = document.getElementById('thumbnails');
            c.innerHTML = '';
            uploadedImages.forEach((img, i) => {
                const d = document.createElement('div');
                d.className = 'thumb';
                d.innerHTML = `<img src="${img.dataUrl}" alt="receipt ${i+1}"><button class="thumb-remove" onclick="removeImage(${i})">&#10005;</button>`;
                c.appendChild(d);
            });
            document.getElementById('fileCount').textContent = uploadedImages.length > 0 ? `&#127804; ${uploadedImages.length} file(s) selected` : '';
        }

        function removeImage(i) { uploadedImages.splice(i, 1); renderThumbnails(); updateOcrButton(); }

        function updateOcrButton() {
            document.getElementById('ocrBtn').disabled = uploadedImages.length === 0 || !document.getElementById('apiKey').value.trim();
        }

        // ===== Particle effect (lily themed) =====
        function spawnParticles(el) {
            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const container = document.createElement('div');
            container.className = 'particle-container';
            container.style.left = cx + 'px';
            container.style.top = cy + 'px';
            document.body.appendChild(container);

            const colors = ['#C9A0E8','#E8B4D0','#B388E8','#9B72CF','#D4A0D0','#A88BC8'];
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const angle = (Math.PI * 2 * i) / 20;
                const dist = 40 + Math.random() * 60;
                p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                p.style.background = colors[i % colors.length];
                p.style.width = (4 + Math.random() * 6) + 'px';
                p.style.height = p.style.width;
                container.appendChild(p);
            }
            setTimeout(() => container.remove(), 1200);
        }

        // ===== Status =====
        function showStatus(msg, type = 'info') {
            const bar = document.getElementById('statusBar');
            bar.className = `status-bar show status-${type}`;
            document.getElementById('statusText').innerHTML = msg;
        }
        function hideStatus() { document.getElementById('statusBar').className = 'status-bar'; }

        function showLoading(current, total) {
            const c = document.getElementById('loadingContainer');
            c.classList.add('show');
            const msgIdx = Math.min(current, LOADING_MESSAGES.length - 1);
            document.getElementById('loadingText').innerHTML = LOADING_MESSAGES[msgIdx].text;
            document.getElementById('loadingSub').textContent = `(${current+1}/${total}) ${LOADING_MESSAGES[msgIdx].sub}`;
            document.getElementById('progressFill').style.width = `${((current+1)/total)*100}%`;
        }
        function hideLoading() {
            document.getElementById('loadingContainer').classList.remove('show');
            document.getElementById('progressFill').style.width = '0%';
        }

        // ===== OCR =====
        async function startOCR() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert(`Please enter ${API_CONFIG[currentApi].label} API Key.`); return; }
            if (uploadedImages.length === 0) { alert('Please upload images.'); return; }

            const ocrBtn = document.getElementById('ocrBtn');
            ocrBtn.disabled = true;
            hideStatus();

            ocrResults = [];
            let allRows = [];

            for (let i = 0; i < uploadedImages.length; i++) {
                showLoading(i, uploadedImages.length);
                try {
                    const result = await callOCR(apiKey, uploadedImages[i].dataUrl, uploadedImages[i].file.type);
                    if (result.rows) allRows = allRows.concat(result.rows);
                } catch (err) {
                    hideLoading();
                    showStatus(`OCR Error (image ${i+1}): ${err.message}`, 'error');
                    ocrBtn.disabled = false;
                    return;
                }
            }
            hideLoading();

            if (allRows.length === 0) {
                showStatus('No data extracted.', 'error');
                ocrBtn.disabled = false;
                return;
            }

            ocrResults = allRows.map(row => {
                const nameResult = findKoreanName(row.customer_name || '');
                const rawDate = row.date || '';

                let dateDisplay = rawDate;
                let excelSerial = null;
                const dateMatch = rawDate.match(/[레레이와]*(\d+)년\s*(\d+)월\s*(\d+)일/);
                if (dateMatch) {
                    const ry = parseInt(dateMatch[1]);
                    const m = parseInt(dateMatch[2]);
                    const d = parseInt(dateMatch[3]);
                    dateDisplay = `레이와${ry}년-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    excelSerial = reiwaToExcelSerial(ry, m, d);
                }

                return {
                    dateDisplay,
                    excelSerial,
                    originalName: (row.customer_name || '').replace(/様$/g, '').trim(),
                    koreanName: nameResult.name || '',
                    nameConfidence: nameResult.confidence,
                    originalService: row.service_description || '',
                    koreanService: translateService(row.service_description || ''),
                    vehicleCount: row.vehicle_count || 1,
                    amount: row.amount || 0,
                };
            });

            spawnParticles(ocrBtn);
            showLilyBloom(`${ocrResults.length} items extracted!`);
            showStatus(`&#127804; ${ocrResults.length} records extracted successfully!`, 'success');
            ocrBtn.disabled = false;

            renderDataTable();
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dataView').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            updateSummary();
        }

        // ===== API Router =====
        async function callOCR(apiKey, dataUrl, mimeType) {
            const base64Data = dataUrl.split(',')[1];
            const actualMimeType = dataUrl.split(';')[0].split(':')[1] || mimeType;
            const prompt = OCR_PROMPT + '\n\n반드시 JSON만 출력하세요. 다른 텍스트 없이 JSON 객체만 반환하세요.';

            let text;
            if (currentApi === 'claude') text = await callClaude(apiKey, base64Data, actualMimeType, prompt);
            else if (currentApi === 'gemini') text = await callGemini(apiKey, base64Data, actualMimeType, prompt);
            else if (currentApi === 'openai') text = await callOpenAI(apiKey, dataUrl, prompt);

            if (!text) throw new Error('API response is empty.');

            try { return JSON.parse(text); }
            catch (e) {
                const b = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (b) return JSON.parse(b[1]);
                const m = text.match(/\{[\s\S]*\}/);
                if (m) return JSON.parse(m[0]);
                throw new Error('JSON parsing failed');
            }
        }

        async function callClaude(apiKey, base64Data, mimeType, prompt) {
            const supported = ['image/png','image/jpeg','image/gif','image/webp'];
            const mediaType = supported.includes(mimeType) ? mimeType : 'image/png';
            const r = await fetch('https://api.anthropic.com/v1/messages', {
                method:'POST',
                headers:{ 'Content-Type':'application/json', 'x-api-key':apiKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
                body: JSON.stringify({ model:'claude-sonnet-4-5-20250929', max_tokens:4096, messages:[{ role:'user', content:[
                    { type:'image', source:{ type:'base64', media_type:mediaType, data:base64Data } },
                    { type:'text', text:prompt }
                ]}], temperature:0.1 })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `Claude API Error (${r.status})`); }
            const d = await r.json(); return d.content?.[0]?.text;
        }

        async function callGemini(apiKey, base64Data, mimeType, prompt) {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ contents:[{ parts:[{ inlineData:{ mimeType, data:base64Data } },{ text:prompt }] }], generationConfig:{ responseMimeType:'application/json', temperature:0.1 } })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `Gemini API Error (${r.status})`); }
            const d = await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function callOpenAI(apiKey, dataUrl, prompt) {
            const r = await fetch('https://api.openai.com/v1/chat/completions', {
                method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
                body: JSON.stringify({ model:'gpt-4o', max_tokens:4096, messages:[{ role:'user', content:[
                    { type:'image_url', image_url:{ url:dataUrl, detail:'high' } },
                    { type:'text', text:prompt }
                ]}], temperature:0.1 })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `OpenAI API Error (${r.status})`); }
            const d = await r.json(); return d.choices?.[0]?.message?.content;
        }

        // ===== Data Table =====
        function renderDataTable() {
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';

            if (ocrResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">No data.</td></tr>`;
                document.getElementById('totalDisplay').textContent = '';
                return;
            }

            ocrResults.forEach((row, i) => {
                const tr = document.createElement('tr');
                const nameClass = row.nameConfidence === 'unknown' ? 'unknown-cell' : '';

                tr.innerHTML = `
                    <td><input type="text" value="${row.dateDisplay}" style="width:150px;font-size:12px" onchange="updateRow(${i},'dateDisplay',this.value)" placeholder="레이와○년-MM-DD"></td>
                    <td style="font-size:11px;color:var(--muted)">${row.originalName}</td>
                    <td class="${nameClass}"><input class="name-input" value="${row.koreanName}" placeholder="Korean name" onchange="updateRow(${i},'koreanName',this.value)"></td>
                    <td><input class="service-input" value="${row.koreanService}" onchange="updateRow(${i},'koreanService',this.value)"></td>
                    <td><input type="number" class="amount-input" value="${row.vehicleCount}" min="1" style="width:45px" onchange="updateRow(${i},'vehicleCount',this.value)"></td>
                    <td><input type="number" class="amount-input" value="${row.amount}" onchange="updateRow(${i},'amount',this.value)"></td>
                    <td><button class="row-btn row-btn-del" onclick="deleteRow(${i})">&#10005;</button></td>
                `;
                tbody.appendChild(tr);
            });

            const total = ocrResults.reduce((s, r) => s + Number(r.amount), 0);
            document.getElementById('totalDisplay').innerHTML = `&#127804; Total: ${total.toLocaleString()} JPY`;
        }

        function updateRow(index, field, value) {
            if (field === 'vehicleCount') ocrResults[index][field] = parseInt(value) || 1;
            else if (field === 'amount') ocrResults[index][field] = parseFloat(value) || 0;
            else if (field === 'dateDisplay') {
                ocrResults[index].dateDisplay = value;
                const dateMatch = value.match(/(\d+)년[^\d]*(\d+)[^\d]*(\d+)/);
                if (dateMatch) {
                    ocrResults[index].excelSerial = reiwaToExcelSerial(parseInt(dateMatch[1]), parseInt(dateMatch[2]), parseInt(dateMatch[3]));
                }
            }
            else ocrResults[index][field] = value;

            if (field === 'koreanName' && value && ocrResults[index].originalName) {
                const key = ocrResults[index].originalName.toUpperCase().replace(/\s+/g, ' ').trim();
                if (!NAME_MAP[key]) {
                    const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
                    m[key] = value;
                    localStorage.setItem('user_name_map', JSON.stringify(m));
                    ocrResults[index].nameConfidence = 'user';
                    renderMappings();
                }
            }
            updateSummary();
        }

        function deleteRow(i) { ocrResults.splice(i, 1); renderDataTable(); updateSummary(); }

        function addRow() {
            ocrResults.push({
                dateDisplay:'', excelSerial:null,
                originalName:'', koreanName:'', nameConfidence:'unknown',
                originalService:'', koreanService:'', vehicleCount:1, amount:0,
            });
            renderDataTable();
        }

        function sortData() {
            ocrResults.sort((a, b) => (a.excelSerial || 99999) - (b.excelSerial || 99999));
            renderDataTable();
        }

        function updateSummary() {
            const total = ocrResults.reduce((s, r) => s + Number(r.amount), 0);
            const count = ocrResults.length;
            document.getElementById('summary').innerHTML = `
                <div class="summary-item"><div class="summary-value">${count}</div><div class="summary-label">&#127804; Total Records</div></div>
                <div class="summary-item"><div class="summary-value">${total.toLocaleString()}</div><div class="summary-label">&#127804; Total (JPY)</div></div>
            `;
            document.getElementById('totalDisplay').innerHTML = `&#127804; Total: ${total.toLocaleString()} JPY`;
        }

        // ===== Excel =====
        function downloadExcel() {
            const month = parseInt(document.getElementById('month').value);
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
            const fee = parseFloat(document.getElementById('remittanceFee').value) || 0;
            if (!rate) { alert('Please enter exchange rate.'); return; }

            const btn = document.getElementById('excelBtn');
            btn.classList.add('downloading');
            setTimeout(() => btn.classList.remove('downloading'), 700);
            spawnParticles(btn);
            showLilyBloom('Excel downloaded!');

            const wb = XLSX.utils.book_new();
            const ws = buildSheet(month, ocrResults, rate, fee);
            XLSX.utils.book_append_sheet(wb, ws, `미쯔이${month}월`);
            XLSX.writeFile(wb, `미쯔이택시_${month}월_정산.xlsx`);
            showStatus('&#127804; Excel file downloaded!', 'success');
        }

        function buildSheet(month, data, rate, fee) {
            const ws = {};
            const total = data.reduce((s, r) => s + Number(r.amount), 0);
            const krwTotal = data.reduce((s, r, i) => s + (rate * Number(r.amount)) + (i === 0 ? fee : 0), 0);

            const hdrS = { font:{bold:true,sz:11}, alignment:{horizontal:'center'}, fill:{fgColor:{rgb:'F3EEFA'}}, border:{ top:{style:'thin'}, bottom:{style:'thin'}, left:{style:'thin'}, right:{style:'thin'} } };
            const ttlS = { font:{bold:true,sz:13} };
            const lblS = { font:{bold:true,sz:11} };
            const numS = { numFmt:'#,##0', alignment:{horizontal:'right'} };
            const datS = { numFmt:'yyyy-mm-dd' };
            const bdrS = { border:{ top:{style:'thin',color:{rgb:'E0E0E0'}}, bottom:{style:'thin',color:{rgb:'E0E0E0'}}, left:{style:'thin',color:{rgb:'E0E0E0'}}, right:{style:'thin',color:{rgb:'E0E0E0'}} } };

            ws['D3'] = { v:`미쯔이 ${month}월 정산`, s:ttlS };
            ws['D6'] = { v:'합계', s:lblS }; ws['E6'] = { v:total, t:'n', s:numS }; ws['F6'] = { v:'엔' };
            ws['D7'] = { v:'합계', s:lblS }; ws['E7'] = { v:krwTotal, t:'n', s:numS }; ws['F7'] = { v:'원' };
            ws['D8'] = { v:'송금 수수료 (모인비즈플러스)', s:lblS }; ws['E8'] = { v:fee, t:'n', s:numS }; ws['F8'] = { v:'원' };
            ws['D9'] = { v:'환율 (모인비즈플러스)', s:lblS }; ws['E9'] = { v:rate, t:'n' }; ws['F9'] = { v:'원' };

            ws['B11'] = { v:'날짜', s:hdrS }; ws['C11'] = { v:'이름', s:hdrS }; ws['D11'] = { v:'내용', s:hdrS }; ws['E11'] = { v:'금액', s:hdrS };
            ws['H11'] = { v:'날짜', s:hdrS }; ws['I11'] = { v:'이름', s:hdrS }; ws['J11'] = { v:'금액', s:hdrS };

            data.forEach((row, i) => {
                const r = 12 + i;
                ws[`B${r}`] = { v:row.dateDisplay || '', s:bdrS };
                ws[`H${r}`] = { v:row.dateDisplay || '', s:bdrS };
                ws[`C${r}`] = { v:row.koreanName || row.originalName, s:bdrS };
                ws[`D${r}`] = { v:row.koreanService, s:bdrS };
                ws[`E${r}`] = { v:Number(row.amount), t:'n', s:{...numS,...bdrS} };
                ws[`F${r}`] = { v:'엔', s:bdrS };
                ws[`I${r}`] = { v:row.koreanName || row.originalName, s:bdrS };
                ws[`J${r}`] = i === 0
                    ? { f:`$E$9*E${r}+E8`, t:'n', s:{...numS,...bdrS} }
                    : { f:`$E$9*E${r}`, t:'n', s:{...numS,...bdrS} };
                ws[`K${r}`] = { v:'원', s:bdrS };
            });

            const lastR = 12 + data.length;
            if (data.length > 0) ws[`J${lastR+1}`] = { f:`SUM(J12:J${lastR-1})`, t:'n', s:{...numS,font:{bold:true}} };

            ws['!ref'] = `A1:K${lastR + 3}`;
            ws['!cols'] = [ {wch:3},{wch:12},{wch:10},{wch:26},{wch:10},{wch:3},{wch:4},{wch:12},{wch:10},{wch:13},{wch:3} ];
            return ws;
        }

        // ===== Name Mapping =====
        function addNameMapping() {
            const roman = document.getElementById('newNameRoman').value.trim().toUpperCase();
            const korean = document.getElementById('newNameKorean').value.trim();
            if (!roman || !korean) { alert('Please enter both romanized and Korean names.'); return; }
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            m[roman] = korean;
            localStorage.setItem('user_name_map', JSON.stringify(m));
            document.getElementById('newNameRoman').value = '';
            document.getElementById('newNameKorean').value = '';
            renderMappings();
            ocrResults.forEach(row => {
                const clean = row.originalName.toUpperCase().replace(/\s+/g,' ').trim();
                if (clean === roman && !row.koreanName) { row.koreanName = korean; row.nameConfidence = 'user'; }
            });
            if (ocrResults.length > 0) renderDataTable();
        }

        function removeNameMapping(key) {
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            delete m[key];
            localStorage.setItem('user_name_map', JSON.stringify(m));
            renderMappings();
        }

        function renderMappings() {
            const c = document.getElementById('mappingList');
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            const e = Object.entries(m);
            if (e.length === 0) { c.innerHTML = '<div style="font-size:11px;color:var(--muted);padding:6px 0">No saved mappings</div>'; return; }
            c.innerHTML = e.map(([k,v]) => `<div class="mapping-item"><span>${k}</span><span style="font-weight:600">${v}</span><button class="row-btn row-btn-del" onclick="removeNameMapping('${k}')" style="flex:none">&#10005;</button></div>`).join('');
        }
    </script>
</body>
</html>
