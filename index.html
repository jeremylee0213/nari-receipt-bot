<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lily's Receipt Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <!-- Falling Lily Petals Background -->
    <div class="petal-container" id="petalContainer"></div>

    <div class="app">
        <!-- Left Panel -->
        <div class="left">
            <div class="left-header">
                <h1>&#127799; Lily's Receipt Bot</h1>
                <p>Japanese Taxi Invoice Auto Settlement</p>
            </div>

            <div class="main-actions">
                <!-- Upload -->
                <div class="drop-zone" id="dropZone" role="button" aria-label="Upload receipt images - drag, click, or paste">
                    <div class="drop-zone-icon">&#128206;</div>
                    <div class="drop-zone-text">
                        <strong>Drag</strong>, <strong>Click</strong> or <strong>Ctrl+V</strong><br>
                        <small>PNG, JPG, PDF / Multiple files / Paste supported</small>
                    </div>
                    <input type="file" id="fileInput" accept="image/*,application/pdf" multiple hidden aria-label="Select receipt files">
                </div>
                <div class="thumbnails" id="thumbnails" role="list" aria-label="Uploaded file thumbnails"></div>
                <div class="file-count" id="fileCount" aria-live="polite"></div>

                <div class="section-divider"></div>

                <!-- Settings -->
                <div class="input-row">
                    <div class="input-group">
                        <label for="month">Month</label>
                        <select id="month" aria-label="Settlement month">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="year">Year</label>
                        <input type="number" id="year" value="2026" min="2019" max="2030" aria-label="Settlement year">
                    </div>
                    <div class="input-group">
                        <label for="exchangeRate">Exchange Rate</label>
                        <input type="number" id="exchangeRate" step="0.0001" value="9.3416" aria-label="JPY to KRW exchange rate">
                    </div>
                    <div class="input-group">
                        <label for="remittanceFee">Remittance Fee</label>
                        <input type="number" id="remittanceFee" step="1" value="49485" aria-label="Remittance fee in KRW">
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- OCR Button -->
                <button class="btn-ocr" id="ocrBtn" onclick="startOCR()" disabled aria-label="Start OCR analysis on uploaded images">
                    Start OCR Analysis
                </button>

                <!-- Loading -->
                <div class="loading-container" id="loadingContainer" role="status" aria-live="polite">
                    <div class="loading-dots" aria-hidden="true">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <div class="loading-text" id="loadingText">Analyzing receipts...</div>
                    <div class="loading-sub" id="loadingSub">AI is reading the Japanese text</div>
                    <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div class="progress-fill" id="progressFill"></div></div>
                </div>

                <!-- Status -->
                <div class="status-bar" id="statusBar" role="alert" aria-live="polite">
                    <span id="statusText"></span>
                </div>

                <!-- Download -->
                <div id="downloadSection" style="display:none">
                    <div class="summary" id="summary"></div>
                    <button class="btn-excel" id="excelBtn" onclick="downloadExcel()" style="margin-top:12px" aria-label="Download Excel settlement file">
                        Download Excel
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-toggle" onclick="toggleSettings()" role="button" aria-expanded="false" aria-controls="settingsPanel" tabindex="0">
                <span>&#9881; API & Name Mapping Settings</span>
                <span id="settingsArrow" aria-hidden="true">&#9660;</span>
            </div>
            <div class="settings-panel" id="settingsPanel" role="region" aria-label="Settings">
                <div class="section">
                    <div class="section-title">AI API</div>
                    <div class="input-group">
                        <div class="api-selector" role="tablist" aria-label="Select AI provider">
                            <button class="api-tab active" data-api="claude" onclick="switchApi('claude')" role="tab" aria-selected="true">Claude</button>
                            <button class="api-tab" data-api="gemini" onclick="switchApi('gemini')" role="tab" aria-selected="false">Gemini</button>
                            <button class="api-tab" data-api="openai" onclick="switchApi('openai')" role="tab" aria-selected="false">OpenAI</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="api-key-wrap">
                            <input type="password" id="apiKey" placeholder="API Key" aria-label="AI API key">
                            <button class="api-key-toggle" onclick="toggleApiKey()" aria-label="Toggle API key visibility">&#128065;</button>
                        </div>
                        <div class="api-key-note">API key is stored in browser only (not transmitted to servers)</div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-title">Name Mapping</div>
                    <div class="input-row">
                        <div class="input-group"><input type="text" id="newNameRoman" placeholder="HONG GILDONG" aria-label="Romanized name"></div>
                        <div class="input-group"><input type="text" id="newNameKorean" placeholder="&#54861;&#44600;&#46041;" aria-label="Korean name"></div>
                    </div>
                    <button class="btn-sm btn-outline-sm" onclick="addNameMapping()" aria-label="Add name mapping">Add</button>
                    <div class="mapping-list" id="mappingList" role="list" aria-label="Saved name mappings"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right">
            <div id="emptyState" class="empty-state">
                <div class="empty-state-illustration">
                    <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Receipt/document illustration -->
                        <rect x="25" y="10" width="70" height="90" rx="8" fill="#F3EEFA" stroke="#9B72CF" stroke-width="2"/>
                        <rect x="35" y="25" width="40" height="4" rx="2" fill="#C9A0E8"/>
                        <rect x="35" y="35" width="50" height="3" rx="1.5" fill="#E8B4D0" opacity=".6"/>
                        <rect x="35" y="43" width="45" height="3" rx="1.5" fill="#E8B4D0" opacity=".6"/>
                        <rect x="35" y="51" width="50" height="3" rx="1.5" fill="#E8B4D0" opacity=".6"/>
                        <rect x="35" y="63" width="30" height="4" rx="2" fill="#9B72CF" opacity=".5"/>
                        <rect x="55" y="63" width="30" height="4" rx="2" fill="#7EC8A0" opacity=".5"/>
                        <rect x="35" y="75" width="50" height="3" rx="1.5" fill="#E8B4D0" opacity=".4"/>
                        <rect x="35" y="83" width="35" height="3" rx="1.5" fill="#E8B4D0" opacity=".4"/>
                        <!-- Sparkle -->
                        <circle cx="98" cy="20" r="4" fill="#E8B4D0" opacity=".7"/>
                        <circle cx="15" cy="55" r="3" fill="#C9A0E8" opacity=".5"/>
                        <path d="M105 40l3-8 3 8-8 3 8 3" stroke="#9B72CF" stroke-width="1.5" fill="none" opacity=".5"/>
                    </svg>
                </div>
                <p>Upload receipt images and<br>start OCR analysis</p>
                <div class="empty-hint">Drag & drop, click, or Ctrl+V to paste</div>
            </div>

            <div id="dataView" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                    <h2 style="font-size:17px;font-weight:700;color:var(--primary);font-family:'Quicksand',sans-serif">OCR Results</h2>
                    <div style="display:flex;gap:6px">
                        <button class="btn btn-outline" onclick="addRow()" aria-label="Add new data row">+ Add Row</button>
                        <button class="btn btn-primary" onclick="sortData()" aria-label="Sort data by date">Sort by Date</button>
                    </div>
                </div>

                <div class="data-table-wrap">
                    <table class="data-table" id="dataTable" aria-label="OCR extracted data">
                        <thead>
                            <tr>
                                <th scope="col">Date</th>
                                <th scope="col">Original Name</th>
                                <th scope="col">Korean Name</th>
                                <th scope="col">Description</th>
                                <th scope="col">Qty</th>
                                <th scope="col">Amount (JPY)</th>
                                <th scope="col"><span class="sr-only">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody id="dataBody"></tbody>
                    </table>
                </div>

                <div style="margin-top:14px;text-align:right">
                    <strong id="totalDisplay" style="font-size:15px;color:var(--primary);font-family:'Quicksand',sans-serif" aria-live="polite"></strong>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // ===== State =====
        let uploadedImages = [];
        let ocrResults = [];
        let currentApi = 'claude';
        let petalInterval = null;

        const API_CONFIG = {
            claude: { label:'Claude', placeholder:'Claude API Key (sk-ant-...)', storageKey:'claude_api_key' },
            gemini: { label:'Gemini', placeholder:'Gemini API Key', storageKey:'gemini_api_key' },
            openai: { label:'OpenAI', placeholder:'OpenAI API Key (sk-...)', storageKey:'openai_api_key' },
        };

        const LOADING_MESSAGES = [
            { text:'Analyzing receipts...', sub:'AI is reading Japanese text' },
            { text:'Extracting data...', sub:'Finding dates, names, and amounts' },
            { text:'Converting names...', sub:'Translating romaji to Korean' },
            { text:'Almost done!', sub:'Final verification in progress' },
        ];

        // ===== Error messages (Korean-friendly) =====
        const ERROR_MESSAGES = {
            'invalid_api_key': 'API 키가 유효하지 않습니다. 키를 확인해주세요.',
            'rate_limit': 'API 호출 한도를 초과했습니다. 잠시 후 다시 시도해주세요.',
            'network': '네트워크 오류가 발생했습니다. 인터넷 연결을 확인해주세요.',
            'parse': 'AI 응답을 분석할 수 없습니다. 이미지가 선명한지 확인해주세요.',
            'empty': '추출된 데이터가 없습니다. 올바른 청구서 이미지인지 확인해주세요.',
            'no_key': 'API 키를 입력해주세요.',
            'no_images': '이미지를 업로드해주세요.',
            'no_rate': '환율을 입력해주세요.',
            'both_names': '로마자 이름과 한국어 이름 모두 입력해주세요.',
        };

        function friendlyError(err) {
            const msg = err.message || '';
            if (msg.includes('401') || msg.includes('invalid') || msg.includes('Unauthorized'))
                return ERROR_MESSAGES.invalid_api_key;
            if (msg.includes('429') || msg.includes('rate') || msg.includes('quota'))
                return ERROR_MESSAGES.rate_limit;
            if (msg.includes('network') || msg.includes('fetch') || msg.includes('Failed'))
                return ERROR_MESSAGES.network;
            if (msg.includes('JSON') || msg.includes('parse'))
                return ERROR_MESSAGES.parse;
            return msg;
        }

        // ===== Falling Lily Petals (with visibility management) =====
        function createPetals() {
            const container = document.getElementById('petalContainer');
            const petalSVGs = [
                `<svg width="20" height="24" viewBox="0 0 20 24"><path d="M10 0C10 0 0 8 0 14c0 5.5 4.5 10 10 10s10-4.5 10-10C20 8 10 0 10 0z" fill="rgba(200,160,232,.35)"/></svg>`,
                `<svg width="16" height="20" viewBox="0 0 16 20"><path d="M8 0C8 0 0 6 0 11c0 5 3.5 9 8 9s8-4 8-9C16 6 8 0 8 0z" fill="rgba(232,180,208,.4)"/></svg>`,
                `<svg width="14" height="18" viewBox="0 0 14 18"><ellipse cx="7" cy="9" rx="7" ry="9" fill="rgba(179,136,232,.25)"/></svg>`,
            ];
            function spawnPetal() {
                if (document.hidden) return;
                const petal = document.createElement('div');
                petal.className = 'petal';
                petal.innerHTML = petalSVGs[Math.floor(Math.random() * petalSVGs.length)];
                petal.style.left = Math.random() * 100 + '%';
                petal.style.setProperty('--drift', (Math.random() * 100 - 50) + 'px');
                petal.style.setProperty('--spin', (Math.random() * 720 - 360) + 'deg');
                const duration = 8 + Math.random() * 7;
                petal.style.animationDuration = duration + 's';
                container.appendChild(petal);
                setTimeout(() => petal.remove(), duration * 1000);
            }
            petalInterval = setInterval(spawnPetal, 2500);
            for (let i = 0; i < 5; i++) setTimeout(spawnPetal, i * 800);

            // Pause petals when tab is hidden
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    clearInterval(petalInterval);
                    petalInterval = null;
                } else {
                    if (!petalInterval) petalInterval = setInterval(spawnPetal, 2500);
                }
            });
        }

        // ===== Bloom Celebration =====
        function showLilyBloom(text) {
            const overlay = document.createElement('div');
            overlay.className = 'bloom-overlay';
            overlay.innerHTML = `
                <div class="bloom-lily">&#127799;</div>
                <div class="bloom-text">${text}</div>
            `;
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 2500);
        }

        // ===== Init =====
        window.addEventListener('DOMContentLoaded', () => {
            createPetals();

            const savedApi = localStorage.getItem('selected_api');
            if (savedApi && API_CONFIG[savedApi]) switchApi(savedApi);
            else switchApi('claude');

            document.getElementById('apiKey').addEventListener('change', e => {
                localStorage.setItem(API_CONFIG[currentApi].storageKey, e.target.value.trim());
            });

            const savedRate = localStorage.getItem('exchange_rate');
            const savedFee = localStorage.getItem('remittance_fee');
            if (savedRate) document.getElementById('exchangeRate').value = savedRate;
            if (savedFee) document.getElementById('remittanceFee').value = savedFee;

            document.getElementById('exchangeRate').addEventListener('change', e => localStorage.setItem('exchange_rate', e.target.value));
            document.getElementById('remittanceFee').addEventListener('change', e => localStorage.setItem('remittance_fee', e.target.value));

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
            fileInput.addEventListener('change', e => handleFiles(e.target.files));

            // Keyboard accessibility for settings toggle
            document.querySelector('.settings-toggle').addEventListener('keydown', e => {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSettings(); }
            });

            // Ctrl+V clipboard paste
            document.addEventListener('paste', e => {
                const items = e.clipboardData?.items;
                if (!items) return;
                const imageFiles = [];
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) imageFiles.push(file);
                    }
                }
                if (imageFiles.length > 0) {
                    e.preventDefault();
                    handlePastedImages(imageFiles);
                }
            });

            renderMappings();
        });

        // ===== Settings =====
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const toggle = document.querySelector('.settings-toggle');
            const arrow = document.getElementById('settingsArrow');
            panel.classList.toggle('open');
            const isOpen = panel.classList.contains('open');
            arrow.innerHTML = isOpen ? '&#9650;' : '&#9660;';
            toggle.setAttribute('aria-expanded', isOpen);
        }

        // ===== API =====
        function switchApi(api) {
            currentApi = api;
            const config = API_CONFIG[api];
            const input = document.getElementById('apiKey');
            document.querySelectorAll('.api-tab').forEach(t => {
                const isActive = t.dataset.api === api;
                t.classList.toggle('active', isActive);
                t.setAttribute('aria-selected', isActive);
            });
            input.placeholder = config.placeholder;
            input.value = localStorage.getItem(config.storageKey) || '';
            input.type = 'password';
            localStorage.setItem('selected_api', api);
            updateOcrButton();
        }

        function toggleApiKey() {
            const i = document.getElementById('apiKey');
            i.type = i.type === 'password' ? 'text' : 'password';
        }

        // ===== File handling =====
        function handlePastedImages(files) {
            let added = 0;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = e => {
                    uploadedImages.push({ file, dataUrl: e.target.result });
                    added++;
                    renderThumbnails();
                    updateOcrButton();
                    if (added === 1) {
                        spawnParticles(document.getElementById('dropZone'));
                        showStatus(`${files.length}개 이미지가 클립보드에서 붙여넣기 되었습니다.`, 'success');
                        const dz = document.getElementById('dropZone');
                        dz.classList.add('drag-over');
                        setTimeout(() => dz.classList.remove('drag-over'), 600);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleFiles(files) {
            let added = 0;
            for (const file of files) {
                if (file.type === 'application/pdf') {
                    try {
                        showStatus('PDF를 이미지로 변환 중...', 'info');
                        const pdfImages = await pdfToImages(file);
                        for (const img of pdfImages) {
                            uploadedImages.push(img);
                            added++;
                        }
                        renderThumbnails();
                        updateOcrButton();
                        showStatus(`PDF에서 ${pdfImages.length}페이지가 변환되었습니다.`, 'success');
                        if (added > 0) spawnParticles(document.getElementById('dropZone'));
                    } catch (err) {
                        showStatus(`PDF 오류: ${friendlyError(err)}`, 'error');
                    }
                } else if (file.type.match(/image\/(png|jpeg|jpg|webp)/)) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        uploadedImages.push({ file, dataUrl: e.target.result });
                        added++;
                        renderThumbnails();
                        updateOcrButton();
                        if (added === 1) spawnParticles(document.getElementById('dropZone'));
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        async function pdfToImages(file) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const images = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const scale = 2.0;
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');
                await page.render({ canvasContext: ctx, viewport }).promise;
                const dataUrl = canvas.toDataURL('image/png');
                images.push({
                    file: new File([await (await fetch(dataUrl)).blob()], `${file.name}_page${i}.png`, { type: 'image/png' }),
                    dataUrl
                });
            }
            return images;
        }

        function renderThumbnails() {
            const c = document.getElementById('thumbnails');
            c.innerHTML = '';
            uploadedImages.forEach((img, i) => {
                const d = document.createElement('div');
                d.className = 'thumb';
                d.setAttribute('role', 'listitem');
                d.innerHTML = `<img src="${img.dataUrl}" alt="영수증 ${i+1}"><button class="thumb-remove" onclick="removeImage(${i})" aria-label="이미지 ${i+1} 삭제">&#10005;</button>`;
                c.appendChild(d);
            });
            document.getElementById('fileCount').textContent = uploadedImages.length > 0 ? `${uploadedImages.length}개 파일 선택됨` : '';
        }

        function removeImage(i) { uploadedImages.splice(i, 1); renderThumbnails(); updateOcrButton(); }

        function updateOcrButton() {
            document.getElementById('ocrBtn').disabled = uploadedImages.length === 0 || !document.getElementById('apiKey').value.trim();
        }

        // ===== Particle effect =====
        function spawnParticles(el) {
            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const container = document.createElement('div');
            container.className = 'particle-container';
            container.style.left = cx + 'px';
            container.style.top = cy + 'px';
            document.body.appendChild(container);

            const colors = ['#C9A0E8','#E8B4D0','#B388E8','#9B72CF','#D4A0D0','#A88BC8'];
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const angle = (Math.PI * 2 * i) / 20;
                const dist = 40 + Math.random() * 60;
                p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                p.style.background = colors[i % colors.length];
                p.style.width = (4 + Math.random() * 6) + 'px';
                p.style.height = p.style.width;
                container.appendChild(p);
            }
            setTimeout(() => container.remove(), 1200);
        }

        // ===== Status =====
        function showStatus(msg, type = 'info') {
            const bar = document.getElementById('statusBar');
            bar.className = `status-bar show status-${type}`;
            document.getElementById('statusText').innerHTML = msg;
        }
        function hideStatus() { document.getElementById('statusBar').className = 'status-bar'; }

        function showLoading(current, total) {
            const c = document.getElementById('loadingContainer');
            c.classList.add('show');
            const msgIdx = Math.min(current, LOADING_MESSAGES.length - 1);
            document.getElementById('loadingText').innerHTML = LOADING_MESSAGES[msgIdx].text;
            document.getElementById('loadingSub').textContent = `(${current+1}/${total}) ${LOADING_MESSAGES[msgIdx].sub}`;
            document.getElementById('progressFill').style.width = `${((current+1)/total)*100}%`;
        }
        function hideLoading() {
            document.getElementById('loadingContainer').classList.remove('show');
            document.getElementById('progressFill').style.width = '0%';
        }

        // ===== OCR =====
        async function startOCR() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert(ERROR_MESSAGES.no_key); return; }
            if (uploadedImages.length === 0) { alert(ERROR_MESSAGES.no_images); return; }

            const ocrBtn = document.getElementById('ocrBtn');
            ocrBtn.disabled = true;
            hideStatus();

            ocrResults = [];
            let allRows = [];

            for (let i = 0; i < uploadedImages.length; i++) {
                showLoading(i, uploadedImages.length);
                try {
                    const result = await callOCR(apiKey, uploadedImages[i].dataUrl, uploadedImages[i].file.type);
                    if (result.rows) allRows = allRows.concat(result.rows);
                } catch (err) {
                    hideLoading();
                    showStatus(`OCR 오류 (이미지 ${i+1}): ${friendlyError(err)}`, 'error');
                    ocrBtn.disabled = false;
                    return;
                }
            }
            hideLoading();

            if (allRows.length === 0) {
                showStatus(ERROR_MESSAGES.empty, 'error');
                ocrBtn.disabled = false;
                return;
            }

            ocrResults = allRows.map(row => {
                const nameResult = findKoreanName(row.customer_name || '');
                const rawDate = row.date || '';

                let dateDisplay = rawDate;
                let excelSerial = null;
                const dateMatch = rawDate.match(/[레레이와]*(\d+)년\s*(\d+)월\s*(\d+)일/);
                if (dateMatch) {
                    const ry = parseInt(dateMatch[1]);
                    const m = parseInt(dateMatch[2]);
                    const d = parseInt(dateMatch[3]);
                    dateDisplay = `레이와${ry}년-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    excelSerial = reiwaToExcelSerial(ry, m, d);
                }

                return {
                    dateDisplay,
                    excelSerial,
                    originalName: (row.customer_name || '').replace(/様$/g, '').trim(),
                    koreanName: nameResult.name || '',
                    nameConfidence: nameResult.confidence,
                    originalService: row.service_description || '',
                    koreanService: translateService(row.service_description || ''),
                    vehicleCount: row.vehicle_count || 1,
                    amount: row.amount || 0,
                };
            });

            spawnParticles(ocrBtn);
            showLilyBloom(`${ocrResults.length}건 추출 완료!`);
            showStatus(`&#10047; ${ocrResults.length}건의 데이터가 성공적으로 추출되었습니다.`, 'success');
            ocrBtn.disabled = false;

            renderDataTable();
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dataView').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            updateSummary();
        }

        // ===== API Router =====
        async function callOCR(apiKey, dataUrl, mimeType) {
            const base64Data = dataUrl.split(',')[1];
            const actualMimeType = dataUrl.split(';')[0].split(':')[1] || mimeType;
            const prompt = OCR_PROMPT + '\n\n반드시 JSON만 출력하세요. 다른 텍스트 없이 JSON 객체만 반환하세요.';

            let text;
            if (currentApi === 'claude') text = await callClaude(apiKey, base64Data, actualMimeType, prompt);
            else if (currentApi === 'gemini') text = await callGemini(apiKey, base64Data, actualMimeType, prompt);
            else if (currentApi === 'openai') text = await callOpenAI(apiKey, dataUrl, prompt);

            if (!text) throw new Error('API 응답이 비어 있습니다.');

            try { return JSON.parse(text); }
            catch (e) {
                const b = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (b) return JSON.parse(b[1]);
                const m = text.match(/\{[\s\S]*\}/);
                if (m) return JSON.parse(m[0]);
                throw new Error('JSON 파싱에 실패했습니다.');
            }
        }

        async function callClaude(apiKey, base64Data, mimeType, prompt) {
            const supported = ['image/png','image/jpeg','image/gif','image/webp'];
            const mediaType = supported.includes(mimeType) ? mimeType : 'image/png';
            const r = await fetch('https://api.anthropic.com/v1/messages', {
                method:'POST',
                headers:{ 'Content-Type':'application/json', 'x-api-key':apiKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
                body: JSON.stringify({ model:'claude-sonnet-4-5-20250929', max_tokens:4096, messages:[{ role:'user', content:[
                    { type:'image', source:{ type:'base64', media_type:mediaType, data:base64Data } },
                    { type:'text', text:prompt }
                ]}], temperature:0.1 })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `Claude API 오류 (${r.status})`); }
            const d = await r.json(); return d.content?.[0]?.text;
        }

        async function callGemini(apiKey, base64Data, mimeType, prompt) {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ contents:[{ parts:[{ inlineData:{ mimeType, data:base64Data } },{ text:prompt }] }], generationConfig:{ responseMimeType:'application/json', temperature:0.1 } })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `Gemini API 오류 (${r.status})`); }
            const d = await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function callOpenAI(apiKey, dataUrl, prompt) {
            const r = await fetch('https://api.openai.com/v1/chat/completions', {
                method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
                body: JSON.stringify({ model:'gpt-4o', max_tokens:4096, messages:[{ role:'user', content:[
                    { type:'image_url', image_url:{ url:dataUrl, detail:'high' } },
                    { type:'text', text:prompt }
                ]}], temperature:0.1 })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `OpenAI API 오류 (${r.status})`); }
            const d = await r.json(); return d.choices?.[0]?.message?.content;
        }

        // ===== Data Table =====
        function renderDataTable() {
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';

            if (ocrResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">데이터가 없습니다.</td></tr>`;
                document.getElementById('totalDisplay').textContent = '';
                return;
            }

            ocrResults.forEach((row, i) => {
                const tr = document.createElement('tr');
                const nameClass = row.nameConfidence === 'unknown' ? 'unknown-cell' : '';

                tr.innerHTML = `
                    <td><input type="text" value="${row.dateDisplay}" style="width:150px;font-size:12px" onchange="updateRow(${i},'dateDisplay',this.value)" placeholder="레이와○년-MM-DD" aria-label="날짜 ${i+1}"></td>
                    <td style="font-size:12px;color:var(--muted)">${row.originalName}</td>
                    <td class="${nameClass}"><input class="name-input" value="${row.koreanName}" placeholder="한국어 이름" onchange="updateRow(${i},'koreanName',this.value)" aria-label="한국어 이름 ${i+1}"></td>
                    <td><input class="service-input" value="${row.koreanService}" onchange="updateRow(${i},'koreanService',this.value)" aria-label="서비스 내용 ${i+1}"></td>
                    <td><input type="number" class="amount-input" value="${row.vehicleCount}" min="1" style="width:45px" onchange="updateRow(${i},'vehicleCount',this.value)" aria-label="대수 ${i+1}"></td>
                    <td><input type="number" class="amount-input" value="${row.amount}" onchange="updateRow(${i},'amount',this.value)" aria-label="금액 ${i+1}"></td>
                    <td><button class="row-btn row-btn-del" onclick="deleteRow(${i})" aria-label="행 ${i+1} 삭제">&#10005;</button></td>
                `;
                tbody.appendChild(tr);
            });

            const total = ocrResults.reduce((s, r) => s + Number(r.amount), 0);
            document.getElementById('totalDisplay').innerHTML = `Total: ${total.toLocaleString()} JPY`;
        }

        function updateRow(index, field, value) {
            if (field === 'vehicleCount') ocrResults[index][field] = parseInt(value) || 1;
            else if (field === 'amount') ocrResults[index][field] = parseFloat(value) || 0;
            else if (field === 'dateDisplay') {
                ocrResults[index].dateDisplay = value;
                const dateMatch = value.match(/(\d+)년[^\d]*(\d+)[^\d]*(\d+)/);
                if (dateMatch) {
                    ocrResults[index].excelSerial = reiwaToExcelSerial(parseInt(dateMatch[1]), parseInt(dateMatch[2]), parseInt(dateMatch[3]));
                }
            }
            else ocrResults[index][field] = value;

            if (field === 'koreanName' && value && ocrResults[index].originalName) {
                const key = ocrResults[index].originalName.toUpperCase().replace(/\s+/g, ' ').trim();
                if (!NAME_MAP[key]) {
                    const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
                    m[key] = value;
                    localStorage.setItem('user_name_map', JSON.stringify(m));
                    ocrResults[index].nameConfidence = 'user';
                    renderMappings();
                }
            }
            updateSummary();
        }

        function deleteRow(i) { ocrResults.splice(i, 1); renderDataTable(); updateSummary(); }

        function addRow() {
            ocrResults.push({
                dateDisplay:'', excelSerial:null,
                originalName:'', koreanName:'', nameConfidence:'unknown',
                originalService:'', koreanService:'', vehicleCount:1, amount:0,
            });
            renderDataTable();
        }

        function sortData() {
            ocrResults.sort((a, b) => (a.excelSerial || 99999) - (b.excelSerial || 99999));
            renderDataTable();
        }

        function updateSummary() {
            const total = ocrResults.reduce((s, r) => s + Number(r.amount), 0);
            const count = ocrResults.length;
            document.getElementById('summary').innerHTML = `
                <div class="summary-item"><div class="summary-value">${count}</div><div class="summary-label">Total Records</div></div>
                <div class="summary-item"><div class="summary-value">${total.toLocaleString()}</div><div class="summary-label">Total (JPY)</div></div>
            `;
            document.getElementById('totalDisplay').innerHTML = `Total: ${total.toLocaleString()} JPY`;
        }

        // ===== Excel =====
        function downloadExcel() {
            const month = parseInt(document.getElementById('month').value);
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
            const fee = parseFloat(document.getElementById('remittanceFee').value) || 0;
            if (!rate) { alert(ERROR_MESSAGES.no_rate); return; }

            const btn = document.getElementById('excelBtn');
            btn.classList.add('downloading');
            setTimeout(() => btn.classList.remove('downloading'), 700);
            spawnParticles(btn);
            showLilyBloom('엑셀 다운로드 완료!');

            const wb = XLSX.utils.book_new();
            const ws = buildSheet(month, ocrResults, rate, fee);
            XLSX.utils.book_append_sheet(wb, ws, `미쯔이${month}월`);
            XLSX.writeFile(wb, `미쯔이택시_${month}월_정산.xlsx`);
            showStatus('&#10047; 엑셀 파일이 다운로드되었습니다.', 'success');
        }

        function buildSheet(month, data, rate, fee) {
            const ws = {};
            const total = data.reduce((s, r) => s + Number(r.amount), 0);
            const krwTotal = data.reduce((s, r, i) => s + (rate * Number(r.amount)) + (i === 0 ? fee : 0), 0);

            const hdrS = { font:{bold:true,sz:11}, alignment:{horizontal:'center'}, fill:{fgColor:{rgb:'F3EEFA'}}, border:{ top:{style:'thin'}, bottom:{style:'thin'}, left:{style:'thin'}, right:{style:'thin'} } };
            const ttlS = { font:{bold:true,sz:13} };
            const lblS = { font:{bold:true,sz:11} };
            const numS = { numFmt:'#,##0', alignment:{horizontal:'right'} };
            const datS = { numFmt:'yyyy-mm-dd' };
            const bdrS = { border:{ top:{style:'thin',color:{rgb:'E0E0E0'}}, bottom:{style:'thin',color:{rgb:'E0E0E0'}}, left:{style:'thin',color:{rgb:'E0E0E0'}}, right:{style:'thin',color:{rgb:'E0E0E0'}} } };

            ws['D3'] = { v:`미쯔이 ${month}월 정산`, s:ttlS };
            ws['D6'] = { v:'합계', s:lblS }; ws['E6'] = { v:total, t:'n', s:numS }; ws['F6'] = { v:'엔' };
            ws['D7'] = { v:'합계', s:lblS }; ws['E7'] = { v:krwTotal, t:'n', s:numS }; ws['F7'] = { v:'원' };
            ws['D8'] = { v:'송금 수수료 (모인비즈플러스)', s:lblS }; ws['E8'] = { v:fee, t:'n', s:numS }; ws['F8'] = { v:'원' };
            ws['D9'] = { v:'환율 (모인비즈플러스)', s:lblS }; ws['E9'] = { v:rate, t:'n' }; ws['F9'] = { v:'원' };

            ws['B11'] = { v:'날짜', s:hdrS }; ws['C11'] = { v:'이름', s:hdrS }; ws['D11'] = { v:'내용', s:hdrS }; ws['E11'] = { v:'금액', s:hdrS };
            ws['H11'] = { v:'날짜', s:hdrS }; ws['I11'] = { v:'이름', s:hdrS }; ws['J11'] = { v:'금액', s:hdrS };

            data.forEach((row, i) => {
                const r = 12 + i;
                ws[`B${r}`] = { v:row.dateDisplay || '', s:bdrS };
                ws[`H${r}`] = { v:row.dateDisplay || '', s:bdrS };
                ws[`C${r}`] = { v:row.koreanName || row.originalName, s:bdrS };
                ws[`D${r}`] = { v:row.koreanService, s:bdrS };
                ws[`E${r}`] = { v:Number(row.amount), t:'n', s:{...numS,...bdrS} };
                ws[`F${r}`] = { v:'엔', s:bdrS };
                ws[`I${r}`] = { v:row.koreanName || row.originalName, s:bdrS };
                ws[`J${r}`] = i === 0
                    ? { f:`$E$9*E${r}+E8`, t:'n', s:{...numS,...bdrS} }
                    : { f:`$E$9*E${r}`, t:'n', s:{...numS,...bdrS} };
                ws[`K${r}`] = { v:'원', s:bdrS };
            });

            const lastR = 12 + data.length;
            if (data.length > 0) ws[`J${lastR+1}`] = { f:`SUM(J12:J${lastR-1})`, t:'n', s:{...numS,font:{bold:true}} };

            ws['!ref'] = `A1:K${lastR + 3}`;
            ws['!cols'] = [ {wch:3},{wch:12},{wch:10},{wch:26},{wch:10},{wch:3},{wch:4},{wch:12},{wch:10},{wch:13},{wch:3} ];
            return ws;
        }

        // ===== Name Mapping =====
        function addNameMapping() {
            const roman = document.getElementById('newNameRoman').value.trim().toUpperCase();
            const korean = document.getElementById('newNameKorean').value.trim();
            if (!roman || !korean) { alert(ERROR_MESSAGES.both_names); return; }
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            m[roman] = korean;
            localStorage.setItem('user_name_map', JSON.stringify(m));
            document.getElementById('newNameRoman').value = '';
            document.getElementById('newNameKorean').value = '';
            renderMappings();
            ocrResults.forEach(row => {
                const clean = row.originalName.toUpperCase().replace(/\s+/g,' ').trim();
                if (clean === roman && !row.koreanName) { row.koreanName = korean; row.nameConfidence = 'user'; }
            });
            if (ocrResults.length > 0) renderDataTable();
        }

        function removeNameMapping(key) {
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            delete m[key];
            localStorage.setItem('user_name_map', JSON.stringify(m));
            renderMappings();
        }

        function renderMappings() {
            const c = document.getElementById('mappingList');
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            const e = Object.entries(m);
            if (e.length === 0) { c.innerHTML = '<div style="font-size:12px;color:var(--muted);padding:6px 0">저장된 매핑이 없습니다</div>'; return; }
            c.innerHTML = e.map(([k,v]) => `<div class="mapping-item" role="listitem"><span>${k}</span><span style="font-weight:600">${v}</span><button class="row-btn row-btn-del" onclick="removeNameMapping('${k}')" style="flex:none" aria-label="${k} 매핑 삭제">&#10005;</button></div>`).join('');
        }
    </script>
</body>
</html>
