<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나리 영수증Bot - 택시 정산 자동화</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2E86AB;
            --primary-light: #E8F4F8;
            --bg: #F5F7FA;
            --card: #FFF;
            --text: #2C3E50;
            --muted: #7F8C8D;
            --border: #E0E6ED;
            --success: #27AE60;
            --warning: #F39C12;
            --danger: #E74C3C;
            --shadow: 0 2px 12px rgba(0,0,0,.08);
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .app {
            display: flex;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        .left {
            width: 380px;
            min-width: 380px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        h1 {
            font-size: 20px;
            font-weight: 900;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 4px;
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color .2s;
        }

        input:focus, select:focus {
            border-color: var(--primary);
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row > div { flex: 1; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all .2s;
            width: 100%;
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #246d8e;
        }

        .btn-success {
            background: var(--success);
            color: #fff;
        }

        .btn-success:hover:not(:disabled) {
            background: #1e8449;
        }

        .btn-warning {
            background: var(--warning);
            color: #fff;
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        /* 드래그앤드롭 영역 */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all .2s;
            background: var(--bg);
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .drop-zone-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .drop-zone-text {
            font-size: 13px;
            color: var(--muted);
        }

        .drop-zone-text strong {
            color: var(--primary);
        }

        /* 썸네일 */
        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .thumb {
            position: relative;
            width: 70px;
            height: 70px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: var(--danger);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-count {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        /* 데이터 테이블 */
        .data-table-wrap {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: var(--primary);
            color: #fff;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: var(--primary-light);
        }

        .data-table input {
            padding: 4px 6px;
            font-size: 13px;
            border: 1px solid var(--border);
            border-radius: 4px;
            width: 100%;
            min-width: 60px;
        }

        .data-table .name-input { min-width: 80px; }
        .data-table .service-input { min-width: 140px; }
        .data-table .amount-input { min-width: 80px; text-align: right; }

        .unknown-cell {
            background: #FFF3E0 !important;
        }

        .unknown-cell input {
            border-color: var(--warning);
            background: #FFF8E1;
        }

        .row-actions {
            display: flex;
            gap: 4px;
        }

        .row-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .row-btn-del {
            background: #FDEDEE;
            color: var(--danger);
        }

        /* 상태 표시 */
        .status-bar {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            display: none;
        }

        .status-bar.show { display: flex; align-items: center; gap: 8px; }
        .status-info { background: var(--primary-light); color: var(--primary); }
        .status-success { background: #E8F5E9; color: var(--success); }
        .status-error { background: #FDEDEE; color: var(--danger); }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin .6s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* 진행률 */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width .3s;
        }

        /* 다운로드 버튼 그룹 */
        .download-group {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .download-group .btn { flex: 1; }

        /* 요약 통계 */
        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .summary-item {
            background: var(--bg);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 900;
            color: var(--primary);
        }

        .summary-label {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        /* 이름 매핑 관리 */
        .mapping-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
        }

        .mapping-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--border);
        }

        .mapping-item span { flex: 1; }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* 반기 탭 */
        .half-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 12px;
        }

        .half-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid var(--border);
            cursor: pointer;
            background: var(--bg);
            transition: all .2s;
        }

        .half-tab:first-child { border-radius: 8px 0 0 8px; }
        .half-tab:last-child { border-radius: 0 8px 8px 0; }

        .half-tab.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* API 선택 탭 */
        .api-selector {
            display: flex;
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .api-tab {
            flex: 1;
            padding: 7px 0;
            border: none;
            background: var(--bg);
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all .2s;
            color: var(--muted);
        }

        .api-tab + .api-tab {
            border-left: 1px solid var(--border);
        }

        .api-tab.active {
            background: var(--primary);
            color: #fff;
        }

        .api-tab:hover:not(.active) {
            background: var(--primary-light);
            color: var(--primary);
        }

        /* API키 토글 */
        .api-key-wrap {
            position: relative;
        }

        .api-key-toggle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--muted);
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- 왼쪽 패널: 설정 및 업로드 -->
        <div class="left">
            <h1>나리 영수증Bot</h1>

            <!-- API 설정 -->
            <div class="section">
                <div class="section-title">AI API 설정</div>
                <div class="input-group">
                    <label>API 선택</label>
                    <div class="api-selector">
                        <button class="api-tab active" data-api="claude" onclick="switchApi('claude')">Claude</button>
                        <button class="api-tab" data-api="gemini" onclick="switchApi('gemini')">Gemini</button>
                        <button class="api-tab" data-api="openai" onclick="switchApi('openai')">OpenAI</button>
                    </div>
                </div>
                <div class="input-group">
                    <label id="apiKeyLabel">API Key</label>
                    <div class="api-key-wrap">
                        <input type="password" id="apiKey" placeholder="Claude API Key 입력 (sk-ant-...)">
                        <button class="api-key-toggle" onclick="toggleApiKey()">&#128065;</button>
                    </div>
                </div>
            </div>

            <!-- 정산 설정 -->
            <div class="section">
                <div class="section-title">정산 설정</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>월</label>
                        <select id="month">
                            <option value="1">1월</option>
                            <option value="2">2월</option>
                            <option value="3">3월</option>
                            <option value="4">4월</option>
                            <option value="5">5월</option>
                            <option value="6">6월</option>
                            <option value="7">7월</option>
                            <option value="8">8월</option>
                            <option value="9">9월</option>
                            <option value="10">10월</option>
                            <option value="11">11월</option>
                            <option value="12">12월</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>연도 (서력)</label>
                        <input type="number" id="year" value="2026" min="2019" max="2030">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>환율 (모인비즈플러스)</label>
                        <input type="number" id="exchangeRate" step="0.0001" placeholder="예: 9.3416">
                    </div>
                    <div class="input-group">
                        <label>송금 수수료 (원)</label>
                        <input type="number" id="remittanceFee" step="1" placeholder="예: 49485">
                    </div>
                </div>
            </div>

            <!-- 이미지 업로드 -->
            <div class="section">
                <div class="section-title">영수증 이미지 업로드</div>
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">&#128206;</div>
                    <div class="drop-zone-text">
                        이미지를 드래그하거나 <strong>클릭</strong>하여 업로드<br>
                        <small>PNG, JPG, PDF 지원 / 여러 장 가능</small>
                    </div>
                    <input type="file" id="fileInput" accept="image/*,.pdf" multiple hidden>
                </div>
                <div class="thumbnails" id="thumbnails"></div>
                <div class="file-count" id="fileCount"></div>
            </div>

            <!-- OCR 실행 -->
            <button class="btn btn-primary" id="ocrBtn" onclick="startOCR()" disabled>
                OCR 분석 시작
            </button>

            <!-- 상태 표시 -->
            <div class="status-bar" id="statusBar">
                <div class="spinner"></div>
                <span id="statusText"></span>
            </div>
            <div class="progress-bar" id="progressBar" style="display:none">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- 다운로드 -->
            <div class="section" id="downloadSection" style="display:none">
                <div class="section-title">다운로드</div>
                <div class="summary" id="summary"></div>
                <div class="download-group">
                    <button class="btn btn-success" onclick="downloadExcel()">엑셀 다운로드</button>
                    <button class="btn btn-warning" onclick="downloadPDF()">PDF 다운로드</button>
                </div>
            </div>

            <!-- 이름 매핑 관리 -->
            <div class="section">
                <div class="section-title">이름 매핑 관리</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>로마자</label>
                        <input type="text" id="newNameRoman" placeholder="HONG GILDONG">
                    </div>
                    <div class="input-group">
                        <label>한국이름</label>
                        <input type="text" id="newNameKorean" placeholder="홍길동">
                    </div>
                </div>
                <button class="btn btn-outline btn-sm" onclick="addNameMapping()" style="margin-top:6px">
                    이름 추가
                </button>
                <div class="mapping-list" id="mappingList"></div>
            </div>
        </div>

        <!-- 오른쪽 패널: 데이터 테이블 -->
        <div class="right">
            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">&#128203;</div>
                <p>영수증 이미지를 업로드하고<br>OCR 분석을 시작하세요</p>
            </div>

            <div id="dataView" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2 style="font-size:16px;font-weight:700">OCR 분석 결과</h2>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-outline btn-sm" onclick="addRow()">+ 행 추가</button>
                        <button class="btn btn-sm btn-primary" onclick="sortData()">날짜순 정렬</button>
                    </div>
                </div>

                <div class="half-tabs">
                    <div class="half-tab active" onclick="switchHalf(1)" id="tab1">1차 (1~15일)</div>
                    <div class="half-tab" onclick="switchHalf(2)" id="tab2">2차 (16~말일)</div>
                </div>

                <div class="data-table-wrap">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>원본이름</th>
                                <th>한국이름</th>
                                <th>내용 (한국어)</th>
                                <th>대수</th>
                                <th>금액 (엔)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="dataBody"></tbody>
                    </table>
                </div>

                <div style="margin-top:12px;text-align:right">
                    <strong id="halfTotal" style="font-size:15px;color:var(--primary)"></strong>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // ===== 상태 관리 =====
        let uploadedImages = []; // { file, dataUrl }
        let ocrResults = [];     // 변환된 전체 데이터
        let currentHalf = 1;     // 현재 보기: 1차 or 2차
        let currentApi = 'claude'; // 현재 선택된 API

        const API_CONFIG = {
            claude: { label: 'Claude', placeholder: 'Claude API Key (sk-ant-...)', storageKey: 'claude_api_key' },
            gemini: { label: 'Gemini', placeholder: 'Gemini API Key', storageKey: 'gemini_api_key' },
            openai: { label: 'OpenAI', placeholder: 'OpenAI API Key (sk-...)', storageKey: 'openai_api_key' },
        };

        // ===== 초기화 =====
        window.addEventListener('DOMContentLoaded', () => {
            // 마지막 선택 API 복원
            const savedApi = localStorage.getItem('selected_api');
            if (savedApi && API_CONFIG[savedApi]) {
                switchApi(savedApi);
            } else {
                switchApi('claude');
            }

            // API 키 저장
            document.getElementById('apiKey').addEventListener('change', e => {
                localStorage.setItem(API_CONFIG[currentApi].storageKey, e.target.value.trim());
            });

            // 설정 복원
            const savedRate = localStorage.getItem('exchange_rate');
            const savedFee = localStorage.getItem('remittance_fee');
            if (savedRate) document.getElementById('exchangeRate').value = savedRate;
            if (savedFee) document.getElementById('remittanceFee').value = savedFee;

            document.getElementById('exchangeRate').addEventListener('change', e => {
                localStorage.setItem('exchange_rate', e.target.value);
            });
            document.getElementById('remittanceFee').addEventListener('change', e => {
                localStorage.setItem('remittance_fee', e.target.value);
            });

            // 드래그앤드롭
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', e => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', e => handleFiles(e.target.files));

            // 이름 매핑 표시
            renderMappings();
        });

        // ===== API 전환 =====
        function switchApi(api) {
            currentApi = api;
            const config = API_CONFIG[api];
            const input = document.getElementById('apiKey');

            // 탭 활성화
            document.querySelectorAll('.api-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.api === api);
            });

            // placeholder 및 저장된 키 복원
            input.placeholder = config.placeholder;
            input.value = localStorage.getItem(config.storageKey) || '';
            input.type = 'password';

            localStorage.setItem('selected_api', api);
            updateOcrButton();
        }

        // ===== API 키 토글 =====
        function toggleApiKey() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // ===== 파일 처리 =====
        function handleFiles(files) {
            for (const file of files) {
                if (!file.type.match(/image\/(png|jpeg|jpg|webp)|application\/pdf/)) continue;
                const reader = new FileReader();
                reader.onload = e => {
                    uploadedImages.push({ file, dataUrl: e.target.result });
                    renderThumbnails();
                    updateOcrButton();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderThumbnails() {
            const container = document.getElementById('thumbnails');
            container.innerHTML = '';
            uploadedImages.forEach((img, i) => {
                const thumb = document.createElement('div');
                thumb.className = 'thumb';
                if (img.file.type === 'application/pdf') {
                    thumb.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f0f0f0;font-size:20px">PDF</div>`;
                } else {
                    thumb.innerHTML = `<img src="${img.dataUrl}" alt="receipt ${i + 1}">`;
                }
                thumb.innerHTML += `<button class="thumb-remove" onclick="removeImage(${i})">&#10005;</button>`;
                container.appendChild(thumb);
            });
            document.getElementById('fileCount').textContent =
                uploadedImages.length > 0 ? `${uploadedImages.length}개 파일 선택됨` : '';
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderThumbnails();
            updateOcrButton();
        }

        function updateOcrButton() {
            const btn = document.getElementById('ocrBtn');
            btn.disabled = uploadedImages.length === 0 || !document.getElementById('apiKey').value.trim();
        }

        // ===== 상태 표시 =====
        function showStatus(msg, type = 'info') {
            const bar = document.getElementById('statusBar');
            const text = document.getElementById('statusText');
            bar.className = `status-bar show status-${type}`;
            text.textContent = msg;
            if (type !== 'info') {
                bar.querySelector('.spinner').style.display = 'none';
            } else {
                bar.querySelector('.spinner').style.display = 'block';
            }
        }

        function hideStatus() {
            document.getElementById('statusBar').className = 'status-bar';
        }

        function showProgress(current, total) {
            const bar = document.getElementById('progressBar');
            const fill = document.getElementById('progressFill');
            bar.style.display = 'block';
            fill.style.width = `${(current / total) * 100}%`;
        }

        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
        }

        // ===== OCR 실행 =====
        async function startOCR() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert(`${API_CONFIG[currentApi].label} API Key를 입력하세요.`); return; }
            if (uploadedImages.length === 0) { alert('이미지를 업로드하세요.'); return; }

            const ocrBtn = document.getElementById('ocrBtn');
            ocrBtn.disabled = true;

            ocrResults = [];
            let allRows = [];
            let reiwaYear = null;

            for (let i = 0; i < uploadedImages.length; i++) {
                showStatus(`OCR 분석 중... (${i + 1}/${uploadedImages.length})`, 'info');
                showProgress(i, uploadedImages.length);

                try {
                    const result = await callOCR(apiKey, uploadedImages[i].dataUrl, uploadedImages[i].file.type);
                    if (result.reiwa_year) reiwaYear = result.reiwa_year;
                    if (result.rows) allRows = allRows.concat(result.rows);
                } catch (err) {
                    showStatus(`OCR 오류 (이미지 ${i + 1}): ${err.message}`, 'error');
                    ocrBtn.disabled = false;
                    hideProgress();
                    return;
                }
            }

            showProgress(uploadedImages.length, uploadedImages.length);

            if (allRows.length === 0) {
                showStatus('추출된 데이터가 없습니다.', 'error');
                ocrBtn.disabled = false;
                hideProgress();
                return;
            }

            // 데이터 변환
            const year = parseInt(document.getElementById('year').value);
            if (reiwaYear) {
                document.getElementById('year').value = REIWA_OFFSET + reiwaYear;
            }

            ocrResults = allRows.map(row => {
                const ry = reiwaYear || (year - REIWA_OFFSET);
                const nameResult = findKoreanName(row.customer_name || '');
                return {
                    month: row.month,
                    day: row.day,
                    date: reiwaToDate(ry, row.month, row.day),
                    excelSerial: reiwaToExcelSerial(ry, row.month, row.day),
                    originalName: (row.customer_name || '').replace(/様$/g, '').trim(),
                    koreanName: nameResult.name || '',
                    nameConfidence: nameResult.confidence,
                    originalService: row.service_description || '',
                    koreanService: translateService(row.service_description || ''),
                    vehicleCount: row.vehicle_count || 1,
                    amount: row.amount || 0,
                    isFirstHalf: row.day <= 15,
                };
            });

            showStatus(`${ocrResults.length}건의 데이터를 추출했습니다.`, 'success');
            hideProgress();
            ocrBtn.disabled = false;

            renderDataTable();
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dataView').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            updateSummary();
        }

        // ===== API 라우터 =====
        async function callOCR(apiKey, dataUrl, mimeType) {
            const base64Data = dataUrl.split(',')[1];
            const actualMimeType = dataUrl.split(';')[0].split(':')[1] || mimeType;
            const prompt = OCR_PROMPT + '\n\n반드시 JSON만 출력하세요. 다른 텍스트 없이 JSON 객체만 반환하세요.';

            let text;
            if (currentApi === 'claude') {
                text = await callClaude(apiKey, base64Data, actualMimeType, prompt);
            } else if (currentApi === 'gemini') {
                text = await callGemini(apiKey, base64Data, actualMimeType, prompt);
            } else if (currentApi === 'openai') {
                text = await callOpenAI(apiKey, dataUrl, prompt);
            }

            if (!text) throw new Error('API 응답이 비어있습니다.');

            // JSON 파싱 (공통)
            try {
                return JSON.parse(text);
            } catch (e) {
                const jsonBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonBlockMatch) return JSON.parse(jsonBlockMatch[1]);
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) return JSON.parse(jsonMatch[0]);
                throw new Error('JSON 파싱 실패');
            }
        }

        // ----- Claude API -----
        async function callClaude(apiKey, base64Data, mimeType, prompt) {
            const supportedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
            const mediaType = supportedTypes.includes(mimeType) ? mimeType : 'image/png';

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-5-20250929',
                    max_tokens: 4096,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64Data } },
                            { type: 'text', text: prompt }
                        ]
                    }],
                    temperature: 0.1
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `Claude API 오류 (${response.status})`);
            }
            const data = await response.json();
            return data.content?.[0]?.text;
        }

        // ----- Gemini API -----
        async function callGemini(apiKey, base64Data, mimeType, prompt) {
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inlineData: { mimeType: mimeType, data: base64Data } },
                                { text: prompt }
                            ]
                        }],
                        generationConfig: { responseMimeType: 'application/json', temperature: 0.1 }
                    })
                }
            );

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `Gemini API 오류 (${response.status})`);
            }
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        // ----- OpenAI API -----
        async function callOpenAI(apiKey, dataUrl, prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    max_tokens: 4096,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'image_url', image_url: { url: dataUrl, detail: 'high' } },
                            { type: 'text', text: prompt }
                        ]
                    }],
                    temperature: 0.1
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `OpenAI API 오류 (${response.status})`);
            }
            const data = await response.json();
            return data.choices?.[0]?.message?.content;
        }

        // ===== 데이터 테이블 =====
        function renderDataTable() {
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';

            const filtered = ocrResults.filter(r =>
                currentHalf === 1 ? r.isFirstHalf : !r.isFirstHalf
            );

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">
                    해당 기간의 데이터가 없습니다.</td></tr>`;
                document.getElementById('halfTotal').textContent = '';
                return;
            }

            filtered.forEach((row, i) => {
                const globalIndex = ocrResults.indexOf(row);
                const tr = document.createElement('tr');
                const nameClass = row.nameConfidence === 'unknown' ? 'unknown-cell' : '';

                const year = parseInt(document.getElementById('year').value);
                const dateStr = `${year}-${String(row.month).padStart(2,'0')}-${String(row.day).padStart(2,'0')}`;

                tr.innerHTML = `
                    <td>
                        <input type="date" value="${dateStr}" style="width:130px"
                            onchange="updateRowDate(${globalIndex},this.value)">
                    </td>
                    <td style="font-size:11px;color:var(--muted)">${row.originalName}</td>
                    <td class="${nameClass}">
                        <input class="name-input" value="${row.koreanName}"
                            placeholder="한국이름 입력"
                            onchange="updateRow(${globalIndex},'koreanName',this.value)">
                    </td>
                    <td>
                        <input class="service-input" value="${row.koreanService}"
                            onchange="updateRow(${globalIndex},'koreanService',this.value)">
                    </td>
                    <td>
                        <input type="number" class="amount-input" value="${row.vehicleCount}" min="1" style="width:50px"
                            onchange="updateRow(${globalIndex},'vehicleCount',this.value)">
                    </td>
                    <td>
                        <input type="number" class="amount-input" value="${row.amount}"
                            onchange="updateRow(${globalIndex},'amount',this.value)">
                    </td>
                    <td>
                        <div class="row-actions">
                            <button class="row-btn row-btn-del" onclick="deleteRow(${globalIndex})">&#10005;</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 합계 표시
            const total = filtered.reduce((sum, r) => sum + Number(r.amount), 0);
            document.getElementById('halfTotal').textContent =
                `${currentHalf}차 합계: ${total.toLocaleString()} 엔`;
        }

        function switchHalf(half) {
            currentHalf = half;
            document.getElementById('tab1').className = half === 1 ? 'half-tab active' : 'half-tab';
            document.getElementById('tab2').className = half === 2 ? 'half-tab active' : 'half-tab';
            renderDataTable();
        }

        function updateRowDate(index, dateStr) {
            // dateStr = "2026-01-05"
            const parts = dateStr.split('-');
            if (parts.length !== 3) return;
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);
            const ry = year - REIWA_OFFSET;

            ocrResults[index].month = month;
            ocrResults[index].day = day;
            ocrResults[index].date = reiwaToDate(ry, month, day);
            ocrResults[index].excelSerial = reiwaToExcelSerial(ry, month, day);
            ocrResults[index].isFirstHalf = day <= 15;
            updateSummary();
        }

        function updateRow(index, field, value) {
            if (field === 'month' || field === 'day' || field === 'vehicleCount') {
                ocrResults[index][field] = parseInt(value) || 0;
            } else if (field === 'amount') {
                ocrResults[index][field] = parseFloat(value) || 0;
            } else {
                ocrResults[index][field] = value;
            }

            // 날짜 변경 시 연관 필드 업데이트
            if (field === 'month' || field === 'day') {
                const year = parseInt(document.getElementById('year').value);
                const ry = year - REIWA_OFFSET;
                ocrResults[index].date = reiwaToDate(ry, ocrResults[index].month, ocrResults[index].day);
                ocrResults[index].excelSerial = reiwaToExcelSerial(ry, ocrResults[index].month, ocrResults[index].day);
                ocrResults[index].isFirstHalf = ocrResults[index].day <= 15;
            }

            // 이름 변경 시 사용자 매핑 자동 저장
            if (field === 'koreanName' && value && ocrResults[index].originalName) {
                const key = ocrResults[index].originalName.toUpperCase().replace(/\s+/g, ' ').trim();
                if (!NAME_MAP[key]) {
                    const userMap = JSON.parse(localStorage.getItem('user_name_map') || '{}');
                    userMap[key] = value;
                    localStorage.setItem('user_name_map', JSON.stringify(userMap));
                    ocrResults[index].nameConfidence = 'user';
                    renderMappings();
                }
            }

            updateSummary();
        }

        function deleteRow(index) {
            ocrResults.splice(index, 1);
            renderDataTable();
            updateSummary();
        }

        function addRow() {
            const month = parseInt(document.getElementById('month').value);
            const defaultDay = currentHalf === 1 ? 1 : 16;
            const year = parseInt(document.getElementById('year').value);
            const ry = year - REIWA_OFFSET;

            ocrResults.push({
                month: month,
                day: defaultDay,
                date: reiwaToDate(ry, month, defaultDay),
                excelSerial: reiwaToExcelSerial(ry, month, defaultDay),
                originalName: '',
                koreanName: '',
                nameConfidence: 'unknown',
                originalService: '',
                koreanService: '',
                vehicleCount: 1,
                amount: 0,
                isFirstHalf: currentHalf === 1,
            });
            renderDataTable();
        }

        function sortData() {
            ocrResults.sort((a, b) => a.excelSerial - b.excelSerial);
            renderDataTable();
        }

        function updateSummary() {
            const first = ocrResults.filter(r => r.isFirstHalf);
            const second = ocrResults.filter(r => !r.isFirstHalf);
            const totalFirst = first.reduce((s, r) => s + Number(r.amount), 0);
            const totalSecond = second.reduce((s, r) => s + Number(r.amount), 0);

            document.getElementById('summary').innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${totalFirst.toLocaleString()}</div>
                    <div class="summary-label">1차 합계 (엔)</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${totalSecond.toLocaleString()}</div>
                    <div class="summary-label">2차 합계 (엔)</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${first.length}</div>
                    <div class="summary-label">1차 건수</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${second.length}</div>
                    <div class="summary-label">2차 건수</div>
                </div>
            `;

            // 반기 탭 합계 업데이트
            const filtered = currentHalf === 1 ? first : second;
            const total = filtered.reduce((s, r) => s + Number(r.amount), 0);
            document.getElementById('halfTotal').textContent =
                `${currentHalf}차 합계: ${total.toLocaleString()} 엔`;
        }

        // ===== 엑셀 생성 =====
        function downloadExcel() {
            const month = parseInt(document.getElementById('month').value);
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0;
            const fee = parseFloat(document.getElementById('remittanceFee').value) || 0;

            if (!exchangeRate) {
                alert('환율을 입력하세요.');
                return;
            }

            const wb = XLSX.utils.book_new();

            const first = ocrResults.filter(r => r.isFirstHalf)
                .sort((a, b) => a.excelSerial - b.excelSerial);
            const second = ocrResults.filter(r => !r.isFirstHalf)
                .sort((a, b) => a.excelSerial - b.excelSerial);

            // 시트 생성
            const ws = buildSheet(month, first, second, exchangeRate, fee);
            XLSX.utils.book_append_sheet(wb, ws, `미쯔이${month}월`);

            XLSX.writeFile(wb, `미쯔이택시_${month}월_정산.xlsx`);
            showStatus('엑셀 파일이 다운로드되었습니다.', 'success');
        }

        function buildSheet(month, firstData, secondData, rate, fee) {
            const ws = {};
            const maxRows = Math.max(firstData.length, secondData.length);
            const totalRows = 12 + maxRows + 5;

            // 헤더 스타일
            const headerStyle = {
                font: { bold: true, sz: 11 },
                alignment: { horizontal: 'center' },
                fill: { fgColor: { rgb: 'E8F4F8' } },
                border: {
                    top: { style: 'thin' },
                    bottom: { style: 'thin' },
                    left: { style: 'thin' },
                    right: { style: 'thin' },
                }
            };

            const titleStyle = {
                font: { bold: true, sz: 13 },
            };

            const labelStyle = {
                font: { bold: true, sz: 11 },
            };

            const numberStyle = {
                numFmt: '#,##0',
                alignment: { horizontal: 'right' },
            };

            const dateStyle = {
                numFmt: 'yyyy-mm-dd',
            };

            const cellBorder = {
                border: {
                    top: { style: 'thin', color: { rgb: 'E0E0E0' } },
                    bottom: { style: 'thin', color: { rgb: 'E0E0E0' } },
                    left: { style: 'thin', color: { rgb: 'E0E0E0' } },
                    right: { style: 'thin', color: { rgb: 'E0E0E0' } },
                }
            };

            // === 1차 (왼쪽, B~K) ===
            // D3: 타이틀
            ws['D3'] = { v: `미쯔이 ${month}월1차 송금 (1~15일)`, s: titleStyle };

            // 합계 정보
            const totalFirst = firstData.reduce((s, r) => s + Number(r.amount), 0);
            const krwTotal1 = firstData.reduce((s, r, i) => {
                return s + (rate * Number(r.amount)) + (i === 0 ? fee : 0);
            }, 0);

            ws['D6'] = { v: '합계', s: labelStyle };
            ws['E6'] = { v: totalFirst, t: 'n', s: numberStyle };
            ws['F6'] = { v: '엔' };

            ws['D7'] = { v: '합계', s: labelStyle };
            ws['E7'] = { v: krwTotal1, t: 'n', s: numberStyle };
            ws['F7'] = { v: '원' };

            ws['D8'] = { v: '송금 수수료 (모인비즈플러스)', s: labelStyle };
            ws['E8'] = { v: fee, t: 'n', s: numberStyle };
            ws['F8'] = { v: '원' };

            ws['D9'] = { v: '환율 (모인비즈플러스)', s: labelStyle };
            ws['E9'] = { v: rate, t: 'n' };
            ws['F9'] = { v: '원' };

            // 헤더 행
            ws['B11'] = { v: '날짜', s: headerStyle };
            ws['C11'] = { v: '이름', s: headerStyle };
            ws['D11'] = { v: '내용', s: headerStyle };
            ws['E11'] = { v: '금액', s: headerStyle };

            ws['H11'] = { v: '날짜', s: headerStyle };
            ws['I11'] = { v: '이름', s: headerStyle };
            ws['J11'] = { v: '금액', s: headerStyle };

            // 데이터 행 (1차)
            firstData.forEach((row, i) => {
                const r = 12 + i;
                ws[`B${r}`] = { v: row.excelSerial, t: 'n', s: dateStyle };
                ws[`C${r}`] = { v: row.koreanName || row.originalName, s: cellBorder };
                ws[`D${r}`] = { v: row.koreanService, s: cellBorder };
                ws[`E${r}`] = { v: Number(row.amount), t: 'n', s: { ...numberStyle, ...cellBorder } };
                ws[`F${r}`] = { v: '엔', s: cellBorder };

                ws[`H${r}`] = { v: row.excelSerial, t: 'n', s: dateStyle };
                ws[`I${r}`] = { v: row.koreanName || row.originalName, s: cellBorder };

                // 원화 환산 공식
                if (i === 0) {
                    ws[`J${r}`] = { f: `$E$9*E${r}+E8`, t: 'n', s: { ...numberStyle, ...cellBorder } };
                } else {
                    ws[`J${r}`] = { f: `$E$9*E${r}`, t: 'n', s: { ...numberStyle, ...cellBorder } };
                }
                ws[`K${r}`] = { v: '원', s: cellBorder };
            });

            // === 2차 (오른쪽, M~V) ===
            ws['O3'] = { v: `미쯔이 ${month}월2차 송금 (16~말일)`, s: titleStyle };

            const totalSecond = secondData.reduce((s, r) => s + Number(r.amount), 0);
            const krwTotal2 = secondData.reduce((s, r, i) => {
                return s + (rate * Number(r.amount)) + (i === 0 ? fee : 0);
            }, 0);

            ws['O6'] = { v: '합계', s: labelStyle };
            ws['P6'] = { v: totalSecond, t: 'n', s: numberStyle };
            ws['Q6'] = { v: '엔' };

            ws['O7'] = { v: '합계', s: labelStyle };
            ws['P7'] = { v: krwTotal2, t: 'n', s: numberStyle };
            ws['Q7'] = { v: '원' };

            ws['O8'] = { v: '송금 수수료 (모인비즈플러스)', s: labelStyle };
            ws['P8'] = { v: fee, t: 'n', s: numberStyle };
            ws['Q8'] = { v: '원' };

            ws['O9'] = { v: '환율 (모인비즈플러스)', s: labelStyle };
            ws['P9'] = { v: rate, t: 'n' };
            ws['Q9'] = { v: '원' };

            ws['M11'] = { v: '날짜', s: headerStyle };
            ws['N11'] = { v: '이름', s: headerStyle };
            ws['O11'] = { v: '내용', s: headerStyle };
            ws['P11'] = { v: '금액', s: headerStyle };

            ws['S11'] = { v: '날짜', s: headerStyle };
            ws['T11'] = { v: '이름', s: headerStyle };
            ws['U11'] = { v: '금액', s: headerStyle };

            // 데이터 행 (2차)
            secondData.forEach((row, i) => {
                const r = 12 + i;
                ws[`M${r}`] = { v: row.excelSerial, t: 'n', s: dateStyle };
                ws[`N${r}`] = { v: row.koreanName || row.originalName, s: cellBorder };
                ws[`O${r}`] = { v: row.koreanService, s: cellBorder };
                ws[`P${r}`] = { v: Number(row.amount), t: 'n', s: { ...numberStyle, ...cellBorder } };
                ws[`Q${r}`] = { v: '엔', s: cellBorder };

                ws[`S${r}`] = { v: row.excelSerial, t: 'n', s: dateStyle };
                ws[`T${r}`] = { v: row.koreanName || row.originalName, s: cellBorder };

                if (i === 0) {
                    ws[`U${r}`] = { f: `$P$9*P${r}+P8`, t: 'n', s: { ...numberStyle, ...cellBorder } };
                } else {
                    ws[`U${r}`] = { f: `$P$9*P${r}`, t: 'n', s: { ...numberStyle, ...cellBorder } };
                }
                ws[`V${r}`] = { v: '원', s: cellBorder };
            });

            // KRW 합계
            const lastRow1 = 12 + firstData.length;
            const lastRow2 = 12 + secondData.length;
            if (firstData.length > 0) {
                ws[`J${lastRow1 + 2}`] = {
                    f: `SUM(J12:J${lastRow1 - 1})`,
                    t: 'n',
                    s: { ...numberStyle, font: { bold: true } }
                };
            }

            // 시트 범위 설정
            ws['!ref'] = `A1:V${Math.max(lastRow1, lastRow2) + 5}`;

            // 컬럼 너비
            ws['!cols'] = [
                { wch: 3 },   // A
                { wch: 11 },  // B
                { wch: 9 },   // C
                { wch: 26 },  // D
                { wch: 9 },   // E
                { wch: 3 },   // F
                { wch: 4 },   // G
                { wch: 11 },  // H
                { wch: 9 },   // I
                { wch: 12 },  // J
                { wch: 3 },   // K
                { wch: 1 },   // L
                { wch: 11 },  // M
                { wch: 9 },   // N
                { wch: 22 },  // O
                { wch: 10 },  // P
                { wch: 3 },   // Q
                { wch: 3 },   // R
                { wch: 11 },  // S
                { wch: 9 },   // T
                { wch: 12 },  // U
                { wch: 3 },   // V
            ];

            return ws;
        }

        // ===== PDF 생성 =====
        function downloadPDF() {
            if (uploadedImages.length === 0) {
                alert('업로드된 이미지가 없습니다.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 190;
            const pageHeight = 277;
            let processed = 0;

            showStatus('PDF 생성 중...', 'info');

            const processImage = (index) => {
                if (index >= uploadedImages.length) {
                    const month = document.getElementById('month').value;
                    doc.save(`미쯔이택시_${month}월_영수증.pdf`);
                    showStatus('PDF 파일이 다운로드되었습니다.', 'success');
                    return;
                }

                if (index > 0) doc.addPage();

                const img = uploadedImages[index];

                if (img.file.type === 'application/pdf') {
                    // PDF는 텍스트로 표시
                    doc.setFontSize(14);
                    doc.text(`PDF 파일: ${img.file.name}`, 10, 20);
                    processImage(index + 1);
                } else {
                    const image = new Image();
                    image.onload = () => {
                        const ratio = image.height / image.width;
                        let imgWidth = pageWidth;
                        let imgHeight = imgWidth * ratio;

                        if (imgHeight > pageHeight) {
                            imgHeight = pageHeight;
                            imgWidth = imgHeight / ratio;
                        }

                        const x = (210 - imgWidth) / 2;
                        doc.addImage(img.dataUrl, 'JPEG', x, 10, imgWidth, imgHeight);
                        processImage(index + 1);
                    };
                    image.src = img.dataUrl;
                }
            };

            processImage(0);
        }

        // ===== 이름 매핑 관리 =====
        function addNameMapping() {
            const roman = document.getElementById('newNameRoman').value.trim().toUpperCase();
            const korean = document.getElementById('newNameKorean').value.trim();
            if (!roman || !korean) { alert('로마자와 한국이름을 모두 입력하세요.'); return; }

            const userMap = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            userMap[roman] = korean;
            localStorage.setItem('user_name_map', JSON.stringify(userMap));

            document.getElementById('newNameRoman').value = '';
            document.getElementById('newNameKorean').value = '';
            renderMappings();

            // 현재 데이터에도 적용
            ocrResults.forEach(row => {
                const clean = row.originalName.toUpperCase().replace(/\s+/g, ' ').trim();
                if (clean === roman && !row.koreanName) {
                    row.koreanName = korean;
                    row.nameConfidence = 'user';
                }
            });
            if (ocrResults.length > 0) renderDataTable();
        }

        function removeNameMapping(key) {
            const userMap = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            delete userMap[key];
            localStorage.setItem('user_name_map', JSON.stringify(userMap));
            renderMappings();
        }

        function renderMappings() {
            const container = document.getElementById('mappingList');
            const userMap = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            const entries = Object.entries(userMap);

            if (entries.length === 0) {
                container.innerHTML = '<div style="font-size:12px;color:var(--muted);padding:8px 0">저장된 사용자 매핑이 없습니다.</div>';
                return;
            }

            container.innerHTML = entries.map(([key, val]) => `
                <div class="mapping-item">
                    <span>${key}</span>
                    <span style="font-weight:600">${val}</span>
                    <button class="row-btn row-btn-del" onclick="removeNameMapping('${key}')" style="flex:none">&#10005;</button>
                </div>
            `).join('');
        }
    </script>
</body>

</html>
