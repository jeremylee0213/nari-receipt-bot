<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나리 영수증Bot - 택시 정산 자동화</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        :root {
            --primary: #2E86AB;
            --primary-light: #E8F4F8;
            --bg: #F5F7FA;
            --card: #FFF;
            --text: #2C3E50;
            --muted: #7F8C8D;
            --border: #E0E6ED;
            --success: #27AE60;
            --warning: #F39C12;
            --danger: #E74C3C;
            --radius: 10px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Noto Sans KR',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* ===== 레이아웃 ===== */
        .app { display:flex; min-height:100vh; max-width:1500px; margin:0 auto; }
        .left { width:420px; min-width:420px; background:var(--card); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow-y:auto; }
        .right { flex:1; padding:20px; overflow-y:auto; }

        /* 왼쪽 상단 헤더 */
        .left-header { padding:20px 24px 16px; border-bottom:1px solid var(--border); }
        .left-header h1 { font-size:22px; font-weight:900; color:var(--primary); }
        .left-header p { font-size:12px; color:var(--muted); margin-top:2px; }

        /* 메인 액션 영역 */
        .main-actions { padding:20px 24px; flex:1; display:flex; flex-direction:column; gap:16px; }

        /* 드래그앤드롭 */
        .drop-zone { border:2px dashed var(--border); border-radius:var(--radius); padding:36px 20px; text-align:center; cursor:pointer; transition:all .3s; background:var(--bg); }
        .drop-zone:hover, .drop-zone.drag-over { border-color:var(--primary); background:var(--primary-light); transform:scale(1.01); }
        .drop-zone-icon { font-size:42px; margin-bottom:6px; }
        .drop-zone-text { font-size:13px; color:var(--muted); }
        .drop-zone-text strong { color:var(--primary); }

        .thumbnails { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
        .thumb { position:relative; width:56px; height:56px; border-radius:6px; overflow:hidden; border:1px solid var(--border); transition:transform .2s; }
        .thumb:hover { transform:scale(1.1); }
        .thumb img { width:100%; height:100%; object-fit:cover; }
        .thumb-remove { position:absolute; top:1px; right:1px; width:16px; height:16px; background:var(--danger); color:#fff; border:none; border-radius:50%; font-size:9px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .file-count { font-size:12px; color:var(--muted); margin-top:4px; }

        /* OCR 버튼 (크게) */
        .btn-ocr {
            padding:18px 24px; border:none; border-radius:12px; font-size:18px; font-weight:900;
            font-family:inherit; cursor:pointer; width:100%; color:#fff;
            background:linear-gradient(135deg, #2E86AB, #1a6b8a);
            box-shadow:0 4px 15px rgba(46,134,171,.3);
            transition:all .3s; position:relative; overflow:hidden;
        }
        .btn-ocr:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 6px 25px rgba(46,134,171,.4); }
        .btn-ocr:active:not(:disabled) { transform:translateY(0); }
        .btn-ocr:disabled { opacity:.4; cursor:not-allowed; transform:none; }

        /* 엑셀 다운로드 버튼 (크게) */
        .btn-excel {
            padding:18px 24px; border:none; border-radius:12px; font-size:18px; font-weight:900;
            font-family:inherit; cursor:pointer; width:100%; color:#fff;
            background:linear-gradient(135deg, #27AE60, #1e8449);
            box-shadow:0 4px 15px rgba(39,174,96,.3);
            transition:all .3s; position:relative; overflow:hidden;
        }
        .btn-excel:hover { transform:translateY(-2px); box-shadow:0 6px 25px rgba(39,174,96,.4); }
        .btn-excel:active { transform:translateY(0); }
        .btn-excel.downloading { animation:btn-celebrate .6s ease; }
        @keyframes btn-celebrate {
            0% { transform:scale(1); }
            30% { transform:scale(.95); }
            60% { transform:scale(1.05); }
            100% { transform:scale(1); }
        }

        /* 상태 표시 */
        .status-bar { padding:10px 14px; border-radius:8px; font-size:13px; font-weight:500; display:none; align-items:center; gap:8px; }
        .status-bar.show { display:flex; }
        .status-info { background:var(--primary-light); color:var(--primary); }
        .status-success { background:#E8F5E9; color:var(--success); }
        .status-error { background:#FDEDEE; color:var(--danger); }

        /* 로딩 애니메이션 */
        .loading-container { display:none; flex-direction:column; align-items:center; gap:16px; padding:20px; }
        .loading-container.show { display:flex; }

        .loading-dots { display:flex; gap:8px; align-items:center; }
        .loading-dot {
            width:12px; height:12px; border-radius:50%; background:var(--primary);
            animation:dot-bounce 1.4s ease-in-out infinite;
        }
        .loading-dot:nth-child(2) { animation-delay:.2s; background:#3498DB; }
        .loading-dot:nth-child(3) { animation-delay:.4s; background:#1ABC9C; }
        .loading-dot:nth-child(4) { animation-delay:.6s; background:#27AE60; }
        @keyframes dot-bounce {
            0%,80%,100% { transform:scale(.4); opacity:.3; }
            40% { transform:scale(1); opacity:1; }
        }

        .loading-text { font-size:14px; font-weight:600; color:var(--primary); }
        .loading-sub { font-size:12px; color:var(--muted); }

        .progress-bar { width:100%; height:8px; background:var(--border); border-radius:4px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--primary),#1ABC9C); border-radius:4px; transition:width .4s ease; }

        /* 파티클 효과 (업로드 성공 시) */
        .particle-container { position:fixed; pointer-events:none; z-index:9999; }
        .particle {
            position:absolute; width:8px; height:8px; border-radius:50%;
            animation:particle-fly 1s ease-out forwards;
        }
        @keyframes particle-fly {
            0% { opacity:1; transform:translate(0,0) scale(1); }
            100% { opacity:0; transform:translate(var(--tx),var(--ty)) scale(0); }
        }

        /* 요약 */
        .summary { display:flex; gap:10px; margin-top:8px; }
        .summary-item { flex:1; background:var(--bg); padding:12px; border-radius:8px; text-align:center; }
        .summary-value { font-size:20px; font-weight:900; color:var(--primary); }
        .summary-label { font-size:11px; color:var(--muted); margin-top:2px; }

        /* 하단 설정 (접을 수 있는) */
        .settings-toggle {
            padding:12px 24px; border-top:1px solid var(--border); cursor:pointer;
            display:flex; align-items:center; justify-content:space-between;
            font-size:12px; font-weight:600; color:var(--muted); background:var(--bg);
            transition:background .2s;
        }
        .settings-toggle:hover { background:var(--primary-light); }
        .settings-panel { padding:0 24px; max-height:0; overflow:hidden; transition:max-height .3s ease, padding .3s ease; background:var(--card); }
        .settings-panel.open { max-height:600px; padding:16px 24px; }

        .section { margin-bottom:12px; }
        .section-title { font-size:12px; font-weight:700; color:var(--primary); margin-bottom:8px; padding-bottom:4px; border-bottom:1px solid var(--primary-light); }

        label { display:block; font-size:11px; font-weight:500; color:var(--muted); margin-bottom:3px; }
        input, select { width:100%; padding:7px 10px; border:1px solid var(--border); border-radius:6px; font-size:13px; font-family:inherit; outline:none; transition:border-color .2s; }
        input:focus, select:focus { border-color:var(--primary); }
        .input-group { margin-bottom:8px; }
        .input-row { display:flex; gap:8px; }
        .input-row > div { flex:1; }

        /* API 선택 탭 */
        .api-selector { display:flex; border-radius:6px; overflow:hidden; border:1px solid var(--border); }
        .api-tab { flex:1; padding:5px 0; border:none; background:var(--bg); font-size:12px; font-weight:600; font-family:inherit; cursor:pointer; transition:all .2s; color:var(--muted); }
        .api-tab+.api-tab { border-left:1px solid var(--border); }
        .api-tab.active { background:var(--primary); color:#fff; }
        .api-tab:hover:not(.active) { background:var(--primary-light); color:var(--primary); }
        .api-key-wrap { position:relative; }
        .api-key-toggle { position:absolute; right:6px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; font-size:13px; color:var(--muted); }

        /* 이름 매핑 */
        .mapping-list { max-height:150px; overflow-y:auto; margin-top:6px; }
        .mapping-item { display:flex; align-items:center; gap:4px; padding:3px 0; font-size:11px; border-bottom:1px solid var(--border); }
        .mapping-item span { flex:1; }
        .btn-sm { padding:4px 8px; font-size:11px; border:none; border-radius:4px; cursor:pointer; font-family:inherit; font-weight:600; }
        .btn-outline-sm { background:transparent; color:var(--primary); border:1px solid var(--primary); }
        .row-btn { width:20px; height:20px; border:none; border-radius:3px; cursor:pointer; font-size:10px; display:flex; align-items:center; justify-content:center; }
        .row-btn-del { background:#FDEDEE; color:var(--danger); }

        /* ===== 오른쪽: 데이터 테이블 ===== */
        .data-table-wrap { overflow-x:auto; }
        .data-table { width:100%; border-collapse:collapse; font-size:13px; }
        .data-table th { background:var(--primary); color:#fff; padding:8px 10px; text-align:left; font-weight:600; white-space:nowrap; position:sticky; top:0; z-index:1; }
        .data-table td { padding:5px 8px; border-bottom:1px solid var(--border); white-space:nowrap; }
        .data-table tr:hover { background:var(--primary-light); }
        .data-table input { padding:3px 5px; font-size:12px; border:1px solid var(--border); border-radius:4px; width:100%; min-width:50px; }
        .data-table .name-input { min-width:70px; }
        .data-table .service-input { min-width:120px; }
        .data-table .amount-input { min-width:70px; text-align:right; }
        .unknown-cell { background:#FFF3E0 !important; }
        .unknown-cell input { border-color:var(--warning); background:#FFF8E1; }

        .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
        .empty-state-icon { font-size:56px; margin-bottom:12px; }

        .btn { display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:6px 12px; border:none; border-radius:6px; font-size:12px; font-weight:600; font-family:inherit; cursor:pointer; transition:all .2s; }
        .btn-primary { background:var(--primary); color:#fff; }
        .btn-outline { background:transparent; color:var(--primary); border:1px solid var(--primary); }
    </style>
</head>
<body>
    <div class="app">
        <!-- 왼쪽 패널 -->
        <div class="left">
            <div class="left-header">
                <h1>나리 영수증Bot</h1>
                <p>일본 택시 청구서 자동 정산</p>
            </div>

            <div class="main-actions">
                <!-- 업로드 -->
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">&#128206;</div>
                    <div class="drop-zone-text">
                        영수증 이미지를 <strong>드래그</strong> 또는 <strong>클릭</strong><br>
                        <small>PNG, JPG 지원 / 여러 장 가능</small>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" multiple hidden>
                </div>
                <div class="thumbnails" id="thumbnails"></div>
                <div class="file-count" id="fileCount"></div>

                <!-- 정산 설정 (간단히) -->
                <div class="input-row">
                    <div class="input-group">
                        <label>월</label>
                        <select id="month">
                            <option value="1">1월</option><option value="2">2월</option><option value="3">3월</option>
                            <option value="4">4월</option><option value="5">5월</option><option value="6">6월</option>
                            <option value="7">7월</option><option value="8">8월</option><option value="9">9월</option>
                            <option value="10">10월</option><option value="11">11월</option><option value="12">12월</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>연도</label>
                        <input type="number" id="year" value="2026" min="2019" max="2030">
                    </div>
                    <div class="input-group">
                        <label>환율</label>
                        <input type="number" id="exchangeRate" step="0.0001" value="9.3416">
                    </div>
                    <div class="input-group">
                        <label>송금수수료</label>
                        <input type="number" id="remittanceFee" step="1" value="49485">
                    </div>
                </div>

                <!-- OCR 버튼 -->
                <button class="btn-ocr" id="ocrBtn" onclick="startOCR()" disabled>
                    OCR 분석 시작
                </button>

                <!-- 로딩 애니메이션 -->
                <div class="loading-container" id="loadingContainer">
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <div class="loading-text" id="loadingText">영수증 분석 중...</div>
                    <div class="loading-sub" id="loadingSub">AI가 일본어 텍스트를 읽고 있어요</div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                </div>

                <!-- 상태 -->
                <div class="status-bar" id="statusBar">
                    <span id="statusText"></span>
                </div>

                <!-- 요약 + 다운로드 -->
                <div id="downloadSection" style="display:none">
                    <div class="summary" id="summary"></div>
                    <button class="btn-excel" id="excelBtn" onclick="downloadExcel()" style="margin-top:12px">
                        엑셀 다운로드
                    </button>
                </div>
            </div>

            <!-- 하단 접이식 설정 -->
            <div class="settings-toggle" onclick="toggleSettings()">
                <span>API 및 이름 매핑 설정</span>
                <span id="settingsArrow">&#9660;</span>
            </div>
            <div class="settings-panel" id="settingsPanel">
                <!-- API 설정 -->
                <div class="section">
                    <div class="section-title">AI API</div>
                    <div class="input-group">
                        <div class="api-selector">
                            <button class="api-tab active" data-api="claude" onclick="switchApi('claude')">Claude</button>
                            <button class="api-tab" data-api="gemini" onclick="switchApi('gemini')">Gemini</button>
                            <button class="api-tab" data-api="openai" onclick="switchApi('openai')">OpenAI</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="api-key-wrap">
                            <input type="password" id="apiKey" placeholder="API Key 입력">
                            <button class="api-key-toggle" onclick="toggleApiKey()">&#128065;</button>
                        </div>
                    </div>
                </div>

                <!-- 이름 매핑 -->
                <div class="section">
                    <div class="section-title">이름 매핑</div>
                    <div class="input-row">
                        <div class="input-group"><input type="text" id="newNameRoman" placeholder="HONG GILDONG"></div>
                        <div class="input-group"><input type="text" id="newNameKorean" placeholder="홍길동"></div>
                    </div>
                    <button class="btn-sm btn-outline-sm" onclick="addNameMapping()">추가</button>
                    <div class="mapping-list" id="mappingList"></div>
                </div>
            </div>
        </div>

        <!-- 오른쪽 패널 -->
        <div class="right">
            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">&#128203;</div>
                <p>영수증 이미지를 업로드하고<br>OCR 분석을 시작하세요</p>
            </div>

            <div id="dataView" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2 style="font-size:16px;font-weight:700">OCR 분석 결과</h2>
                    <div style="display:flex;gap:6px">
                        <button class="btn btn-outline" onclick="addRow()">+ 행 추가</button>
                        <button class="btn btn-primary" onclick="sortData()">날짜순 정렬</button>
                    </div>
                </div>

                <div class="data-table-wrap">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>원본이름</th>
                                <th>한국이름</th>
                                <th>내용 (한국어)</th>
                                <th>대수</th>
                                <th>금액 (엔)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="dataBody"></tbody>
                    </table>
                </div>

                <div style="margin-top:12px;text-align:right">
                    <strong id="totalDisplay" style="font-size:15px;color:var(--primary)"></strong>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // ===== 상태 =====
        let uploadedImages = [];
        let ocrResults = [];
        let currentApi = 'claude';

        const API_CONFIG = {
            claude: { label:'Claude', placeholder:'Claude API Key (sk-ant-...)', storageKey:'claude_api_key' },
            gemini: { label:'Gemini', placeholder:'Gemini API Key', storageKey:'gemini_api_key' },
            openai: { label:'OpenAI', placeholder:'OpenAI API Key (sk-...)', storageKey:'openai_api_key' },
        };

        const LOADING_MESSAGES = [
            { text:'영수증 분석 중...', sub:'AI가 일본어 텍스트를 읽고 있어요' },
            { text:'데이터 추출 중...', sub:'날짜, 이름, 금액을 찾고 있어요' },
            { text:'이름 변환 중...', sub:'로마자를 한국어로 바꾸고 있어요' },
            { text:'거의 다 됐어요!', sub:'마지막 검증 중이에요' },
        ];

        // ===== 초기화 =====
        window.addEventListener('DOMContentLoaded', () => {
            const savedApi = localStorage.getItem('selected_api');
            if (savedApi && API_CONFIG[savedApi]) switchApi(savedApi);
            else switchApi('claude');

            document.getElementById('apiKey').addEventListener('change', e => {
                localStorage.setItem(API_CONFIG[currentApi].storageKey, e.target.value.trim());
            });

            const savedRate = localStorage.getItem('exchange_rate');
            const savedFee = localStorage.getItem('remittance_fee');
            if (savedRate) document.getElementById('exchangeRate').value = savedRate;
            if (savedFee) document.getElementById('remittanceFee').value = savedFee;

            document.getElementById('exchangeRate').addEventListener('change', e => localStorage.setItem('exchange_rate', e.target.value));
            document.getElementById('remittanceFee').addEventListener('change', e => localStorage.setItem('remittance_fee', e.target.value));

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
            fileInput.addEventListener('change', e => handleFiles(e.target.files));

            renderMappings();
        });

        // ===== 설정 패널 토글 =====
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const arrow = document.getElementById('settingsArrow');
            panel.classList.toggle('open');
            arrow.innerHTML = panel.classList.contains('open') ? '&#9650;' : '&#9660;';
        }

        // ===== API =====
        function switchApi(api) {
            currentApi = api;
            const config = API_CONFIG[api];
            const input = document.getElementById('apiKey');
            document.querySelectorAll('.api-tab').forEach(t => t.classList.toggle('active', t.dataset.api === api));
            input.placeholder = config.placeholder;
            input.value = localStorage.getItem(config.storageKey) || '';
            input.type = 'password';
            localStorage.setItem('selected_api', api);
            updateOcrButton();
        }

        function toggleApiKey() {
            const i = document.getElementById('apiKey');
            i.type = i.type === 'password' ? 'text' : 'password';
        }

        // ===== 파일 처리 =====
        function handleFiles(files) {
            let added = 0;
            for (const file of files) {
                if (!file.type.match(/image\/(png|jpeg|jpg|webp)/)) continue;
                const reader = new FileReader();
                reader.onload = e => {
                    uploadedImages.push({ file, dataUrl: e.target.result });
                    added++;
                    renderThumbnails();
                    updateOcrButton();
                    if (added === 1) spawnParticles(document.getElementById('dropZone'));
                };
                reader.readAsDataURL(file);
            }
        }

        function renderThumbnails() {
            const c = document.getElementById('thumbnails');
            c.innerHTML = '';
            uploadedImages.forEach((img, i) => {
                const d = document.createElement('div');
                d.className = 'thumb';
                d.innerHTML = `<img src="${img.dataUrl}" alt="receipt ${i+1}"><button class="thumb-remove" onclick="removeImage(${i})">&#10005;</button>`;
                c.appendChild(d);
            });
            document.getElementById('fileCount').textContent = uploadedImages.length > 0 ? `${uploadedImages.length}개 파일 선택됨` : '';
        }

        function removeImage(i) { uploadedImages.splice(i, 1); renderThumbnails(); updateOcrButton(); }

        function updateOcrButton() {
            document.getElementById('ocrBtn').disabled = uploadedImages.length === 0 || !document.getElementById('apiKey').value.trim();
        }

        // ===== 파티클 효과 =====
        function spawnParticles(el) {
            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const container = document.createElement('div');
            container.className = 'particle-container';
            container.style.left = cx + 'px';
            container.style.top = cy + 'px';
            document.body.appendChild(container);

            const colors = ['#2E86AB','#27AE60','#F39C12','#E74C3C','#9B59B6','#1ABC9C'];
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const angle = (Math.PI * 2 * i) / 20;
                const dist = 40 + Math.random() * 60;
                p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                p.style.background = colors[i % colors.length];
                p.style.width = (4 + Math.random() * 6) + 'px';
                p.style.height = p.style.width;
                container.appendChild(p);
            }
            setTimeout(() => container.remove(), 1200);
        }

        // ===== 상태 표시 =====
        function showStatus(msg, type = 'info') {
            const bar = document.getElementById('statusBar');
            bar.className = `status-bar show status-${type}`;
            document.getElementById('statusText').textContent = msg;
        }
        function hideStatus() { document.getElementById('statusBar').className = 'status-bar'; }

        function showLoading(current, total) {
            const c = document.getElementById('loadingContainer');
            c.classList.add('show');
            const msgIdx = Math.min(current, LOADING_MESSAGES.length - 1);
            document.getElementById('loadingText').textContent = LOADING_MESSAGES[msgIdx].text;
            document.getElementById('loadingSub').textContent = `(${current+1}/${total}) ${LOADING_MESSAGES[msgIdx].sub}`;
            document.getElementById('progressFill').style.width = `${((current+1)/total)*100}%`;
        }
        function hideLoading() {
            document.getElementById('loadingContainer').classList.remove('show');
            document.getElementById('progressFill').style.width = '0%';
        }

        // ===== OCR =====
        async function startOCR() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert(`${API_CONFIG[currentApi].label} API Key를 입력하세요.`); return; }
            if (uploadedImages.length === 0) { alert('이미지를 업로드하세요.'); return; }

            const ocrBtn = document.getElementById('ocrBtn');
            ocrBtn.disabled = true;
            hideStatus();

            ocrResults = [];
            let allRows = [];
            let reiwaYear = null;

            for (let i = 0; i < uploadedImages.length; i++) {
                showLoading(i, uploadedImages.length);
                try {
                    const result = await callOCR(apiKey, uploadedImages[i].dataUrl, uploadedImages[i].file.type);
                    if (result.reiwa_year) reiwaYear = result.reiwa_year;
                    if (result.rows) allRows = allRows.concat(result.rows);
                } catch (err) {
                    hideLoading();
                    showStatus(`OCR 오류 (이미지 ${i+1}): ${err.message}`, 'error');
                    ocrBtn.disabled = false;
                    return;
                }
            }
            hideLoading();

            if (allRows.length === 0) {
                showStatus('추출된 데이터가 없습니다.', 'error');
                ocrBtn.disabled = false;
                return;
            }

            const year = parseInt(document.getElementById('year').value);
            if (reiwaYear) document.getElementById('year').value = REIWA_OFFSET + reiwaYear;

            ocrResults = allRows.map(row => {
                const ry = reiwaYear || (year - REIWA_OFFSET);
                const nameResult = findKoreanName(row.customer_name || '');
                return {
                    month: row.month, day: row.day,
                    date: reiwaToDate(ry, row.month, row.day),
                    excelSerial: reiwaToExcelSerial(ry, row.month, row.day),
                    originalName: (row.customer_name || '').replace(/様$/g, '').trim(),
                    koreanName: nameResult.name || '',
                    nameConfidence: nameResult.confidence,
                    originalService: row.service_description || '',
                    koreanService: translateService(row.service_description || ''),
                    vehicleCount: row.vehicle_count || 1,
                    amount: row.amount || 0,
                };
            });

            // 날짜순 정렬 (이미지 순서 = 날짜순)
            ocrResults.sort((a, b) => a.excelSerial - b.excelSerial);

            spawnParticles(ocrBtn);
            showStatus(`${ocrResults.length}건의 데이터를 추출했습니다!`, 'success');
            ocrBtn.disabled = false;

            renderDataTable();
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dataView').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            updateSummary();
        }

        // ===== API 라우터 =====
        async function callOCR(apiKey, dataUrl, mimeType) {
            const base64Data = dataUrl.split(',')[1];
            const actualMimeType = dataUrl.split(';')[0].split(':')[1] || mimeType;
            const prompt = OCR_PROMPT + '\n\n반드시 JSON만 출력하세요. 다른 텍스트 없이 JSON 객체만 반환하세요.';

            let text;
            if (currentApi === 'claude') text = await callClaude(apiKey, base64Data, actualMimeType, prompt);
            else if (currentApi === 'gemini') text = await callGemini(apiKey, base64Data, actualMimeType, prompt);
            else if (currentApi === 'openai') text = await callOpenAI(apiKey, dataUrl, prompt);

            if (!text) throw new Error('API 응답이 비어있습니다.');

            try { return JSON.parse(text); }
            catch (e) {
                const b = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (b) return JSON.parse(b[1]);
                const m = text.match(/\{[\s\S]*\}/);
                if (m) return JSON.parse(m[0]);
                throw new Error('JSON 파싱 실패');
            }
        }

        async function callClaude(apiKey, base64Data, mimeType, prompt) {
            const supported = ['image/png','image/jpeg','image/gif','image/webp'];
            const mediaType = supported.includes(mimeType) ? mimeType : 'image/png';
            const r = await fetch('https://api.anthropic.com/v1/messages', {
                method:'POST',
                headers:{ 'Content-Type':'application/json', 'x-api-key':apiKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
                body: JSON.stringify({ model:'claude-sonnet-4-5-20250929', max_tokens:4096, messages:[{ role:'user', content:[
                    { type:'image', source:{ type:'base64', media_type:mediaType, data:base64Data } },
                    { type:'text', text:prompt }
                ]}], temperature:0.1 })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `Claude API 오류 (${r.status})`); }
            const d = await r.json(); return d.content?.[0]?.text;
        }

        async function callGemini(apiKey, base64Data, mimeType, prompt) {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ contents:[{ parts:[{ inlineData:{ mimeType, data:base64Data } },{ text:prompt }] }], generationConfig:{ responseMimeType:'application/json', temperature:0.1 } })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `Gemini API 오류 (${r.status})`); }
            const d = await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function callOpenAI(apiKey, dataUrl, prompt) {
            const r = await fetch('https://api.openai.com/v1/chat/completions', {
                method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
                body: JSON.stringify({ model:'gpt-4o', max_tokens:4096, messages:[{ role:'user', content:[
                    { type:'image_url', image_url:{ url:dataUrl, detail:'high' } },
                    { type:'text', text:prompt }
                ]}], temperature:0.1 })
            });
            if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message || `OpenAI API 오류 (${r.status})`); }
            const d = await r.json(); return d.choices?.[0]?.message?.content;
        }

        // ===== 데이터 테이블 (1차/2차 구분 없이 전체) =====
        function renderDataTable() {
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';

            if (ocrResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">데이터가 없습니다.</td></tr>`;
                document.getElementById('totalDisplay').textContent = '';
                return;
            }

            ocrResults.forEach((row, i) => {
                const tr = document.createElement('tr');
                const nameClass = row.nameConfidence === 'unknown' ? 'unknown-cell' : '';
                const year = parseInt(document.getElementById('year').value);
                const dateStr = `${year}-${String(row.month).padStart(2,'0')}-${String(row.day).padStart(2,'0')}`;

                tr.innerHTML = `
                    <td><input type="date" value="${dateStr}" style="width:125px" onchange="updateRowDate(${i},this.value)"></td>
                    <td style="font-size:11px;color:var(--muted)">${row.originalName}</td>
                    <td class="${nameClass}"><input class="name-input" value="${row.koreanName}" placeholder="한국이름" onchange="updateRow(${i},'koreanName',this.value)"></td>
                    <td><input class="service-input" value="${row.koreanService}" onchange="updateRow(${i},'koreanService',this.value)"></td>
                    <td><input type="number" class="amount-input" value="${row.vehicleCount}" min="1" style="width:45px" onchange="updateRow(${i},'vehicleCount',this.value)"></td>
                    <td><input type="number" class="amount-input" value="${row.amount}" onchange="updateRow(${i},'amount',this.value)"></td>
                    <td><button class="row-btn row-btn-del" onclick="deleteRow(${i})">&#10005;</button></td>
                `;
                tbody.appendChild(tr);
            });

            const total = ocrResults.reduce((s, r) => s + Number(r.amount), 0);
            document.getElementById('totalDisplay').textContent = `합계: ${total.toLocaleString()} 엔`;
        }

        function updateRowDate(index, dateStr) {
            const p = dateStr.split('-');
            if (p.length !== 3) return;
            const year = parseInt(p[0]), month = parseInt(p[1]), day = parseInt(p[2]);
            const ry = year - REIWA_OFFSET;
            ocrResults[index].month = month;
            ocrResults[index].day = day;
            ocrResults[index].date = reiwaToDate(ry, month, day);
            ocrResults[index].excelSerial = reiwaToExcelSerial(ry, month, day);
            updateSummary();
        }

        function updateRow(index, field, value) {
            if (field === 'vehicleCount') ocrResults[index][field] = parseInt(value) || 1;
            else if (field === 'amount') ocrResults[index][field] = parseFloat(value) || 0;
            else ocrResults[index][field] = value;

            if (field === 'koreanName' && value && ocrResults[index].originalName) {
                const key = ocrResults[index].originalName.toUpperCase().replace(/\s+/g, ' ').trim();
                if (!NAME_MAP[key]) {
                    const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
                    m[key] = value;
                    localStorage.setItem('user_name_map', JSON.stringify(m));
                    ocrResults[index].nameConfidence = 'user';
                    renderMappings();
                }
            }
            updateSummary();
        }

        function deleteRow(i) { ocrResults.splice(i, 1); renderDataTable(); updateSummary(); }

        function addRow() {
            const month = parseInt(document.getElementById('month').value);
            const year = parseInt(document.getElementById('year').value);
            const ry = year - REIWA_OFFSET;
            ocrResults.push({
                month, day:1, date:reiwaToDate(ry, month, 1), excelSerial:reiwaToExcelSerial(ry, month, 1),
                originalName:'', koreanName:'', nameConfidence:'unknown',
                originalService:'', koreanService:'', vehicleCount:1, amount:0,
            });
            renderDataTable();
        }

        function sortData() { ocrResults.sort((a, b) => a.excelSerial - b.excelSerial); renderDataTable(); }

        function updateSummary() {
            const total = ocrResults.reduce((s, r) => s + Number(r.amount), 0);
            const count = ocrResults.length;
            document.getElementById('summary').innerHTML = `
                <div class="summary-item"><div class="summary-value">${count}</div><div class="summary-label">총 건수</div></div>
                <div class="summary-item"><div class="summary-value">${total.toLocaleString()}</div><div class="summary-label">합계 (엔)</div></div>
            `;
            document.getElementById('totalDisplay').textContent = `합계: ${total.toLocaleString()} 엔`;
        }

        // ===== 엑셀 (단일 테이블, 1차/2차 구분 없이) =====
        function downloadExcel() {
            const month = parseInt(document.getElementById('month').value);
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
            const fee = parseFloat(document.getElementById('remittanceFee').value) || 0;
            if (!rate) { alert('환율을 입력하세요.'); return; }

            const btn = document.getElementById('excelBtn');
            btn.classList.add('downloading');
            setTimeout(() => btn.classList.remove('downloading'), 700);
            spawnParticles(btn);

            const wb = XLSX.utils.book_new();
            const sorted = [...ocrResults].sort((a, b) => a.excelSerial - b.excelSerial);
            const ws = buildSheet(month, sorted, rate, fee);
            XLSX.utils.book_append_sheet(wb, ws, `미쯔이${month}월`);
            XLSX.writeFile(wb, `미쯔이택시_${month}월_정산.xlsx`);
            showStatus('엑셀 파일이 다운로드되었습니다!', 'success');
        }

        function buildSheet(month, data, rate, fee) {
            const ws = {};
            const total = data.reduce((s, r) => s + Number(r.amount), 0);
            const krwTotal = data.reduce((s, r, i) => s + (rate * Number(r.amount)) + (i === 0 ? fee : 0), 0);

            const hdrS = { font:{bold:true,sz:11}, alignment:{horizontal:'center'}, fill:{fgColor:{rgb:'E8F4F8'}}, border:{ top:{style:'thin'}, bottom:{style:'thin'}, left:{style:'thin'}, right:{style:'thin'} } };
            const ttlS = { font:{bold:true,sz:13} };
            const lblS = { font:{bold:true,sz:11} };
            const numS = { numFmt:'#,##0', alignment:{horizontal:'right'} };
            const datS = { numFmt:'yyyy-mm-dd' };
            const bdrS = { border:{ top:{style:'thin',color:{rgb:'E0E0E0'}}, bottom:{style:'thin',color:{rgb:'E0E0E0'}}, left:{style:'thin',color:{rgb:'E0E0E0'}}, right:{style:'thin',color:{rgb:'E0E0E0'}} } };

            ws['D3'] = { v:`미쯔이 ${month}월 정산`, s:ttlS };
            ws['D6'] = { v:'합계', s:lblS }; ws['E6'] = { v:total, t:'n', s:numS }; ws['F6'] = { v:'엔' };
            ws['D7'] = { v:'합계', s:lblS }; ws['E7'] = { v:krwTotal, t:'n', s:numS }; ws['F7'] = { v:'원' };
            ws['D8'] = { v:'송금 수수료 (모인비즈플러스)', s:lblS }; ws['E8'] = { v:fee, t:'n', s:numS }; ws['F8'] = { v:'원' };
            ws['D9'] = { v:'환율 (모인비즈플러스)', s:lblS }; ws['E9'] = { v:rate, t:'n' }; ws['F9'] = { v:'원' };

            ws['B11'] = { v:'날짜', s:hdrS }; ws['C11'] = { v:'이름', s:hdrS }; ws['D11'] = { v:'내용', s:hdrS }; ws['E11'] = { v:'금액', s:hdrS };
            ws['H11'] = { v:'날짜', s:hdrS }; ws['I11'] = { v:'이름', s:hdrS }; ws['J11'] = { v:'금액', s:hdrS };

            data.forEach((row, i) => {
                const r = 12 + i;
                ws[`B${r}`] = { v:row.excelSerial, t:'n', s:datS };
                ws[`C${r}`] = { v:row.koreanName || row.originalName, s:bdrS };
                ws[`D${r}`] = { v:row.koreanService, s:bdrS };
                ws[`E${r}`] = { v:Number(row.amount), t:'n', s:{...numS,...bdrS} };
                ws[`F${r}`] = { v:'엔', s:bdrS };
                ws[`H${r}`] = { v:row.excelSerial, t:'n', s:datS };
                ws[`I${r}`] = { v:row.koreanName || row.originalName, s:bdrS };
                ws[`J${r}`] = i === 0
                    ? { f:`$E$9*E${r}+E8`, t:'n', s:{...numS,...bdrS} }
                    : { f:`$E$9*E${r}`, t:'n', s:{...numS,...bdrS} };
                ws[`K${r}`] = { v:'원', s:bdrS };
            });

            const lastR = 12 + data.length;
            if (data.length > 0) ws[`J${lastR+1}`] = { f:`SUM(J12:J${lastR-1})`, t:'n', s:{...numS,font:{bold:true}} };

            ws['!ref'] = `A1:K${lastR + 3}`;
            ws['!cols'] = [ {wch:3},{wch:12},{wch:10},{wch:26},{wch:10},{wch:3},{wch:4},{wch:12},{wch:10},{wch:13},{wch:3} ];
            return ws;
        }

        // ===== 이름 매핑 =====
        function addNameMapping() {
            const roman = document.getElementById('newNameRoman').value.trim().toUpperCase();
            const korean = document.getElementById('newNameKorean').value.trim();
            if (!roman || !korean) { alert('로마자와 한국이름을 모두 입력하세요.'); return; }
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            m[roman] = korean;
            localStorage.setItem('user_name_map', JSON.stringify(m));
            document.getElementById('newNameRoman').value = '';
            document.getElementById('newNameKorean').value = '';
            renderMappings();
            ocrResults.forEach(row => {
                const clean = row.originalName.toUpperCase().replace(/\s+/g,' ').trim();
                if (clean === roman && !row.koreanName) { row.koreanName = korean; row.nameConfidence = 'user'; }
            });
            if (ocrResults.length > 0) renderDataTable();
        }

        function removeNameMapping(key) {
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            delete m[key];
            localStorage.setItem('user_name_map', JSON.stringify(m));
            renderMappings();
        }

        function renderMappings() {
            const c = document.getElementById('mappingList');
            const m = JSON.parse(localStorage.getItem('user_name_map') || '{}');
            const e = Object.entries(m);
            if (e.length === 0) { c.innerHTML = '<div style="font-size:11px;color:var(--muted);padding:6px 0">저장된 매핑 없음</div>'; return; }
            c.innerHTML = e.map(([k,v]) => `<div class="mapping-item"><span>${k}</span><span style="font-weight:600">${v}</span><button class="row-btn row-btn-del" onclick="removeNameMapping('${k}')" style="flex:none">&#10005;</button></div>`).join('');
        }
    </script>
</body>
</html>
